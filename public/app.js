let evaluatedEmpIds=[],currentUser=null;const API_URL="/api";function showLoader(e="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..."){const t=document.getElementById("loader-overlay"),n=t?t.querySelector("p"):null;n&&(n.textContent=e),t&&(t.style.display="flex")}function showMessage(e,t,n){e&&(e.textContent=t,e.className=n?"success-message":"error-message",e.style.display="block",setTimeout((()=>{e&&(e.style.display="none")}),5e3))}function hideLoader(){const e=document.getElementById("loader-overlay");setTimeout((()=>{e&&(e.style.display="none")}),100)}async function callApi(e,t){showLoader(`Ø¬Ø§Ø±ÙŠ ${e}...`);try{const n=await fetch("/api",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:e,payload:t})}),o=await n.text();hideLoader();const a=JSON.parse(o);if(a&&"error"===a.status)throw new Error(a.message);return a}catch(t){throw hideLoader(),console.error(`API Error (${e}):`,t),t}}function renderEmployeesInModal(e){const t=document.getElementById("emp-list-container");e&&0!==e.length?t.innerHTML=e.map((e=>`\n        <div class="ppe-cart-item" style="cursor:pointer; margin-bottom:8px;" onclick="window.selectEmployee('${e.id}', '${e.name}', '${e.company}')">\n            <div style="text-align:right;">\n                <span style="display:block; font-weight:700;">${e.name}</span>\n                <small style="color:#666;">ID: ${e.id} | ${e.project}</small>\n            </div>\n            <i class="fas fa-chevron-left" style="color:#ccc;"></i>\n        </div>\n    `)).join(""):t.innerHTML='<p style="text-align:center; padding:20px; color:#999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ† Ù„Ù„Ø¨Ø­Ø«</p>'}function renderKpiEmpsInModal(e){const t=document.getElementById("kpi-emp-list-container");if(!t)return;const n=[...e].sort(((e,t)=>(e.project||"").localeCompare(t.project||"")));0!==n.length?t.innerHTML=n.map((e=>{const t=String(e.id).trim(),n=(evaluatedEmpIds||[]).some((e=>String(e).trim()===t));return`\n        <div class="ppe-cart-item ${n?"evaluated-row":""}" \n             style="cursor:pointer; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; transition: 0.2s;" \n             onclick="window.selectKpiEmployee('${e.id}', '${e.name}', '${e.jobTitle}', '${e.project}')">\n\n            <div style="text-align:right; flex-grow:1;">\n                <span style="display:block; font-weight:700; color:#333;">\n                    ${e.name} \n                    ${n?'<i class="fas fa-check-circle" style="color:#28a745; margin-right:5px;" title="ØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…"></i>':""}\n                </span>\n                <small style="color:#666;">\n                    <i class="fas fa-id-card-alt"></i> ${e.id} | \n                    <i class="fas fa-project-diagram"></i> ${e.project}\n                </small>\n            </div>\n\n            <div style="margin-right:10px;">\n                ${n?'<span class="badge bg-success" style="font-size:0.75em; color:white; padding:5px 10px; border-radius:12px;">Ù…Ù€ÙƒØªÙ…Ù„</span>':'<i class="fas fa-chevron-left" style="color:#ddd;"></i>'}\n            </div>\n        </div>`})).join(""):t.innerHTML='\n            <div style="text-align:center; padding:40px; color:#666;">\n                <i class="fas fa-users-slash fa-3x" style="margin-bottom:15px; color:#ccc;"></i>\n                <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ù…Ø´Ø§Ø±ÙŠØ¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</p>\n            </div>'}document.addEventListener("DOMContentLoaded",(function(){const e=localStorage.getItem("hse_user_session");if(e)try{const t=JSON.parse(e);setTimeout((()=>{console.log("ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:",t.username),me({userInfo:t})}),100)}catch(e){console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©",e),localStorage.removeItem("hse_user_session")}const t=document.getElementById("loader-overlay"),n=document.getElementById("login-screen"),o=document.getElementById("app-wrapper"),a=document.getElementById("login-form"),s=document.getElementById("login-error"),c=document.getElementById("sidebar"),l=document.getElementById("sidebar-toggle"),r=document.getElementById("content"),i=document.getElementById("sidebar-menu"),d=document.getElementById("logout-btn"),m=document.getElementById("permit-form"),p=document.getElementById("permit-message"),u=(document.getElementById("obs-message"),document.getElementById("close-permit-message")),y=document.getElementById("mon-ncrvio-project"),g=document.getElementById("mon-ncrvio-from"),v=document.getElementById("mon-ncrvio-to"),h=document.getElementById("mon-ncrvio-btn"),f=document.getElementById("mon-ncrvio-table"),E=document.getElementById("monitor-project-filter"),I=document.getElementById("monitor-requester-filter"),w=document.getElementById("monitor-from-date"),b=document.getElementById("monitor-to-date"),B=document.getElementById("monitor-open-only"),L=document.getElementById("monitor-search-btn"),$=document.getElementById("monitor-results-table"),M=document.getElementById("monitor-message"),k=(document.getElementById("kpi-employee-select"),document.getElementById("kpi-period-select"),document.getElementById("kpi-employee-jobtitle"),document.getElementById("kpi-message-area"),document.getElementById("kpi-form-area"),document.getElementById("kpi-list-container"),document.getElementById("kpi-save-btn"),document.getElementById("kpi-save-message"),document.getElementById("ppe-transaction-type")),T=document.getElementById("ppe-form"),x=document.getElementById("ppe-supplier-group"),H=document.getElementById("ppe-transfer-group"),S=document.getElementById("ppe-recipient-group"),j=document.getElementById("ppe-items-group"),C=document.getElementById("ppe-supplier-name"),D=document.getElementById("ppe-supplier-date"),N=document.getElementById("ppe-supplier-destination"),A=document.getElementById("ppe-transfer-source"),P=document.getElementById("ppe-transfer-destination"),U=document.getElementById("ppe-recipient-location-label"),z=document.getElementById("ppe-recipient-location"),O=document.getElementById("ppe-recipient-type"),R=(document.getElementById("ppe-recipient-employee-group"),document.getElementById("ppe-recipient-employee"),document.getElementById("ppe-recipient-contractor-group"),document.getElementById("ppe-recipient-contractor-company")),q=document.getElementById("ppe-recipient-nid"),F=document.getElementById("ppe-nid-search-btn"),_=document.getElementById("ppe-recipient-name"),K=document.getElementById("ppe-item-select"),V=document.getElementById("ppe-item-qty"),Y=document.getElementById("ppe-add-item-btn"),W=document.getElementById("ppe-item-balance"),J=document.getElementById("ppe-cart-container"),G=document.getElementById("ppe-notes"),X=document.getElementById("ppe-save-btn"),Q=document.getElementById("ppe-main-message"),Z=(document.getElementById("ppe-show-all-emp"),document.getElementById("ppe-save-message")),ee=document.getElementById("stock-report-project"),te=document.getElementById("stock-report-search-btn"),ne=document.getElementById("stock-report-results-table"),oe=document.getElementById("stock-report-message"),ae={Dashboard:"fas fa-tachometer-alt",NewPermit:"fas fa-file-signature",ClosePermit:"fas fa-clipboard-check",NewObservation:"fas fa-eye",MyObservations:"fas fa-list-check",NewHazard:"fas fa-exclamation-circle",MyHazards:"fas fa-list-alt",MonitorPermits:"fas fa-tasks",KpiEvaluation:"fas fa-chart-line",ContractorEvaluation:"fas fa-hard-hat",PpeTransactions:"fas fa-boxes",ProjectStockReport:"fas fa-chart-pie",NewTraining:"fas fa-chalkboard-teacher",TrainingLog:"fas fa-clipboard-list",MonitorObservations:"fas fa-search",MonitorHazards:"fas fa-search-location",NewNcrViolation:"fas fa-exclamation-triangle",MyNCRs:"fas fa-clipboard-check",MonitorNcrViolations:"fas fa-folder-open",NewContractor:"fas fa-file-upload",ContractorAnalytics:"fas fa-chart-pie",EmployeeReports:"fas fa-id-card",NewNearMiss:"fas fa-exclamation-triangle",AccidentReport:"fas fa-car-crash",MonitorAccidents:"fas fa-file-medical-alt",MYAccidents:"fas fa-folder-open"},se={Dashboard:"Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",NewPermit:"ØªØµØ±ÙŠØ­ Ø¬Ø¯ÙŠØ¯",ClosePermit:"Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØµØ§Ø±ÙŠØ­",NewObservation:"ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø©",MyObservations:"Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ",NewHazard:"ØªØ³Ø¬ÙŠÙ„ Ø®Ø·Ø± (Hazard)",MyHazards:"ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø®Ø·Ø± Ø§Ù„Ù…ÙØªÙˆØ­Ø©",MonitorPermits:"Ø³Ø¬Ù„ Ø§Ù„ØªØµØ§Ø±ÙŠØ­",KpiEvaluation:"ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",ContractorEvaluation:"ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†",PpeTransactions:"Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®Ø²Ù†",ProjectStockReport:"Ø³Ø¬Ù„ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù†",NewTraining:"ØªØ³Ø¬ÙŠÙ„ ØªØ¯Ø±ÙŠØ¨",TrainingLog:"Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨",MonitorObservations:"Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª",MonitorHazards:"Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±",NewNcrViolation:"ØªØ³Ø¬ÙŠÙ„ NCR / Ù…Ø®Ø§Ù„ÙØ©",MyNCRs:"Ù…ØªØ§Ø¨Ø¹Ø© NCR",MonitorNcrViolations:"Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ùˆ NCR",NewContractor:"ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† (Ø§Ø´ØªØ±Ø§Ø·Ø§Øª)",ContractorAnalytics:"ØªØ­Ù„ÙŠÙ„Ø§Øª Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†",EmployeeReports:"ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",AccidentReport:"ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ø¯Ø«",MonitorAccidents:"ØªÙ‚Ø§Ø±ÙŠØ± Ù…ÙØªÙˆØ­Ø©",NewNearMiss:"Near Miss",MYAccidents:"Ø³Ø¬Ù„ Ø§Ù„Ø­ÙˆØ§Ø¯Ø«"},ce=[{type:"link",id:"Dashboard"},{type:"group",title:"Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµØ§Ø±ÙŠØ­",icon:"fas fa-file-contract",children:["NewPermit","ClosePermit","MonitorPermits"]},{type:"group",title:"Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª",icon:"fas fa-eye",children:["NewObservation","MyObservations","MonitorObservations"]},{type:"group",title:"ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø®Ø·Ø±",icon:"fas fa-exclamation-circle",children:["NewHazard","MyHazards","MonitorHazards"]},{type:"group",title:"Ø§Ù„Ù…Ø®Ø§Ø²Ù† ÙˆØ§Ù„Ù…Ù‡Ù…Ø§Øª",icon:"fas fa-boxes",children:["PpeTransactions","ProjectStockReport"]},{type:"group",title:"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨",icon:"fas fa-chalkboard-teacher",children:["NewTraining","TrainingLog"]},{type:"group",title:"Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (KPIs)",icon:"fas fa-chart-line",children:["KpiEvaluation","ContractorEvaluation"]},{type:"group",title:"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†",icon:"fas fa-hard-hat",children:["NewContractor","ContractorAnalytics"]},{type:"link",id:"NewNearMiss"},{type:"group",title:"Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ùˆ NCR",icon:"fas fa-exclamation-triangle",children:["NewNcrViolation","MyNCRs","MonitorNcrViolations"]},{type:"group",title:"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",icon:"fas fa-users",children:["EmployeeReports"]},{type:"group",title:"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ÙˆØ§Ø¯Ø«",icon:"fas fa-ambulance",children:["AccidentReport","MonitorAccidents","MYAccidents"]}];function le(e="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..."){const n=t?t.querySelector("p"):null;n&&(n.textContent=e),t&&(t.style.display="flex")}function re(){setTimeout((()=>{t&&(t.style.display="none")}),100)}function ie(e,t){e&&(e.innerHTML='<option value="">-- Ø§Ø®ØªØ± --</option>',t&&Array.isArray(t)&&t.forEach((t=>{"string"==typeof t||"number"==typeof t?e.add(new Option(t,t)):t.id&&t.name&&e.add(new Option(t.name,t.id))})))}async function de(e,t){let n=`Ø¬Ø§Ø±ÙŠ ${e}...`;"checkLogin"===e&&(n="Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„..."),"getInitialData"===e&&(n="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..."),"savePermit"===e&&(n="Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØµØ±ÙŠØ­..."),"saveObservation"===e&&(n="Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©..."),"getOpenPermits"===e&&(n="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµØ§Ø±ÙŠØ­..."),"closePermit"===e&&(n="Ø¬Ø§Ø±ÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØµØ±ÙŠØ­..."),"searchPermits"===e&&(n="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«..."),"getEmployeesToEvaluate"===e&&(n="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†..."),"getKPIsForEmployee"===e&&(n="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª..."),"saveEvaluations"===e&&(n="Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…..."),"getInventoryInitData"===e&&(n="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†..."),"getRecipientByNID"===e&&(n="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ..."),"checkStockBalance"===e&&(n="Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø±ØµÙŠØ¯..."),"saveTransaction"===e&&(n="Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©..."),"getProjectStockReport"===e&&(n="Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±..."),le(n);try{const n=await fetch("/api",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:e,payload:t})}),o=await n.text();if(re(),!n.ok){console.error(`API Error Response (${n.status}) for action ${e}:`,o);let t=`API Error: ${n.status} ${n.statusText}`;try{const e=JSON.parse(o);e.message&&(t=e.message)}catch(e){}throw new Error(t)}try{const t=JSON.parse(o);if(t&&"error"===t.status)throw console.error(`Google Script Error for action ${e}:`,t.message),new Error(t.message||"Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.");return t}catch(t){throw console.error(`JSON Parse Error for action ${e}:`,t,"Raw:",o),new Error(`Received invalid response: ${o.substring(0,100)}...`)}}catch(t){throw re(),console.error(`callApi Error for action ${e}:`,t),new Error(`ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… (${e}): ${t.message}`)}}function me(e){localStorage.setItem("hse_user_session",JSON.stringify(e.userInfo)),currentUser=e.userInfo,n&&(n.style.display="none"),o&&(o.style.display="flex");const t=document.getElementById("welcome-user"),a=document.getElementById("user-role");t&&(t.textContent=`Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUser.username}`),a&&(a.textContent=currentUser.role);const s=document.getElementById("dash-welcome"),c=document.getElementById("dash-role-val"),l=document.getElementById("dash-date-val");if(s&&(s.textContent=`Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${currentUser.username}`),c&&(c.textContent=currentUser.role),l){const e={weekday:"long",year:"numeric",month:"long",day:"numeric"};l.textContent=(new Date).toLocaleDateString("ar-EG",e)}!function(e){if(!i)return;if(i.innerHTML="",!e)return;let t=[];t="ALL"===e.toUpperCase()?Object.keys(se):e.split(",").map((e=>e.trim()));ce.forEach((e=>{if("link"===e.type)t.includes(e.id)&&pe(e.id,i);else if("group"===e.type){const n=e.children.filter((e=>t.includes(e)));n.length>0&&function(e,t,n,o){const a=document.createElement("li"),s=document.createElement("a");s.href="#",s.className="menu-toggle",s.innerHTML=`<span><i class="${t}"></i> ${e}</span> <i class="fas fa-chevron-down"></i>`;const c=document.createElement("ul");c.className="submenu",n.forEach((e=>{pe(e,c)})),s.addEventListener("click",(function(e){e.preventDefault(),this.classList.toggle("expanded"),c.classList.toggle("show")})),a.appendChild(s),a.appendChild(c),o.appendChild(a)}(e.title,e.icon,n,i)}}))}(currentUser.sections),async function(){if(!currentUser)return void console.error("Cannot load initial data: User not set.");try{!function(e){if(e&&"success"===e.status){initialData=e,function(e){if(!e)return;const t=(t,n,o="Ø§Ø®ØªØ±...")=>{const a=document.getElementById(t);a?(a.innerHTML=`<option value="">${o}</option>`,e[n]&&Array.isArray(e[n])?e[n].forEach((e=>a.innerHTML+=`<option value="${e}">${e}</option>`)):console.warn(`Data key '${n}' missing/not array for #${t}`)):console.warn(`Select element #${t} not found.`)};t("permit-project","projects"),t("permit-type","permitTypes"),t("permit-requester","requesters"),t("obs-project","projects"),t("monitor-requester-filter","requesters","Ø§Ù„ÙƒÙ„"),t("permit-delay-reason","delayReasons","-- Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨ --")}(initialData);const t=document.getElementById("MonitorPermits");t&&"none"!==t.style.display&&be()}else alert("Failed config: "+(e?e.message:"?"))}(await de("getInitialData",{userInfo:currentUser}))}catch(e){alert("Failed config connect: "+e.message)}}(),ue("Dashboard")}function pe(e,t){if(!se[e])return;const n=document.createElement("li"),o=document.createElement("a");o.href="#",o.dataset.section=e,o.innerHTML=`<i class="${ae[e]}"></i> ${se[e]}`,o.addEventListener("click",(function(e){var t;e.preventDefault(),ue((t=this).dataset.section),document.querySelectorAll("#sidebar-menu a").forEach((e=>e.classList.remove("active"))),t.classList.add("active"),window.innerWidth<=768&&c&&c.classList.remove("active")})),n.appendChild(o),t.appendChild(n)}function ue(e){if(!e)return void console.error("showSection: no id.");document.querySelectorAll(".page-section").forEach((e=>{e&&(e.style.display="none")}));const t=document.getElementById(e);if(t)t.style.display="block","NewPermit"===e&&ge(),"NewObservation"===e&&Mt(),"MyObservations"===e&&St(),"ClosePermit"===e&&we(),"MonitorPermits"===e&&(be(),$&&($.innerHTML="<p>Ø­Ø¯Ø¯ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«...</p>"),M&&(M.style.display="none")),"KpiEvaluation"===e&&initKpiPage(),"PpeTransactions"===e&&xe(),"NewTraining"===e&&async function(){console.log("Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ ØµÙØ­Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (Ø§Ù„Ù…Ø·ÙˆØ±Ø©)...");const e=new Date;document.getElementById("trn-date")&&(document.getElementById("trn-date").value=e.toLocaleDateString("en-CA"));document.getElementById("trn-time")&&(document.getElementById("trn-time").value=e.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}));document.getElementById("trn-trainer")&&currentUser&&(document.getElementById("trn-trainer").value=currentUser.username);try{const e=await de("getTrainingInitData",{userInfo:currentUser});if("success"===e.status){window.ppeEmployees=e.employees;const t=(currentUser.projects||"").toString();let n="ALL"===t?e.projects:e.projects.filter((e=>t.includes(e)));ie(document.getElementById("trn-project"),n),ie(document.getElementById("trn-topic"),e.topics),document.getElementById("trn-cont-company").innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹ --</option>',at=!0}}catch(e){console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨:",e)}}(),"TrainingLog"===e&&initTrainingLogPage(),"ProjectStockReport"===e&&async function(){if(console.log("Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ ØµÙØ­Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±ØµØ¯Ø©..."),ne.innerHTML="",showMessage(oe,"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¨Ø­Ø«",!0),0===Le.length)try{const e=await de("getInventoryInitData",{userInfo:currentUser});"success"===e.status&&(Le=e.locations,$e=e.employees,Me=e.contractors,ke=e.ppeItems)}catch(e){return void showMessage(oe,`Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.message}`,!1)}const e=(currentUser.projects||"").toString().trim();let t=[];if("ALL"===e)t=Le;else{const n=e.split(",");t=Le.filter((e=>n.includes(e)))}Ne(ee,t)}(),"NewHazard"===e&&on(),"MyHazards"===e&&rn(),"MonitorObservations"===e&&dn(Et),"MonitorHazards"===e&&dn(Wt),"ContractorEvaluation"===e&&function(){if(!pn.value){const e=new Date;pn.value=`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}`}if(mn.options.length<=1){const e=(currentUser.projects||"").toString();let t=[];initialData&&initialData.projects&&(t="ALL"===e?initialData.projects:initialData.projects.filter((t=>e.includes(t))),ie(mn,t))}gn.innerHTML='<p style="text-align:center; color:#777;">Ø§Ø®ØªØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø¶ØºØ· "Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…"</p>',vn.style.display="none",un.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹ --</option>',un.disabled=!0}(),"NewNcrViolation"===e&&(Vn(),ko()),"MyNCRs"===e&&to(),"MonitorNcrViolations"===e&&dn(y),"NewContractor"===e&&Ro(),"ContractorAnalytics"===e&&Xo(),"EmployeeReports"===e&&function(){0===na.length&&de("getAllEmployeesForSearch",{}).then((e=>{"success"===e.status&&(na=e.list)}));Qo&&(Qo.value="");ea&&(ea.style.display="none");ta&&(ta.style.display="none")}(),"AccidentReport"===e&&Pa(),"MonitorAccidents"===e&&loadUserOpenAccidents(),"MYAccidents"===e&&function(){Ra&&Ra.options.length<=1&&dn(Ra);Va.innerHTML='<p style="text-align:center; padding:20px; color:#666;">Ø­Ø¯Ø¯ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«...</p>',Ya.style.display="none"}();else{console.error(`Section "#${e}" not found.`);const t=document.getElementById("Dashboard");t&&(t.style.display="block");const n=i?i.querySelector('a[data-section="Dashboard"]'):null;n&&(i.querySelectorAll("a").forEach((e=>e.classList.remove("active"))),n.classList.add("active"))}}function ye(){const e=document.getElementById("permit-delay-group"),t=document.getElementById("permit-delay-reason"),n=document.getElementById("permit-delay-desc");if(!e)return;(new Date).getHours()>=8?(e.style.display="block",t.required=!0,n.required=!0):(e.style.display="none",t.required=!1,n.required=!1,t.value="",n.value="")}function ge(){if(!m||!currentUser)return;m.reset();const e=document.getElementById("permit-issuer"),t=document.getElementById("permit-timestamp"),n=document.getElementById("permit-date");e&&(e.value=currentUser.username),t&&(t.value=(new Date).toLocaleString("ar-EG",{dateStyle:"short",timeStyle:"short"})),n&&(n.valueAsDate=new Date);const o=document.getElementById("permit-subcontractor-group");o&&(o.style.display="none"),ye()}a?a.addEventListener("submit",(async function(e){e.preventDefault();const t=document.getElementById("username"),n=document.getElementById("password");if(t&&n){s&&(s.style.display="none");try{me(await de("checkLogin",{username:t.value,password:n.value}))}catch(e){!function(e){const t=e&&e.message?e.message:"ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.";s?(s.textContent=t,s.style.display="block"):alert(t)}(e)}}})):console.error("#login-form not found."),d?d.addEventListener("click",(function(e){e.preventDefault(),localStorage.removeItem("hse_user_session"),le("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬..."),location.reload()})):console.error("#logout-btn not found."),l&&c?l.addEventListener("click",(function(){c.classList.toggle("active")})):console.error("#sidebar-toggle or #sidebar not found."),r&&c&&r.addEventListener("click",(function(e){c.classList.contains("active")&&l&&!l.contains(e.target)&&c.classList.remove("active")})),m&&m.addEventListener("submit",(async function(e){if(e.preventDefault(),!currentUser)return;const t={projectName:document.getElementById("permit-project")?.value,permitDate:document.getElementById("permit-date")?.value,shift:document.getElementById("permit-shift")?.value,permitType:document.getElementById("permit-type")?.value,requester:document.getElementById("permit-requester")?.value,siteEngineer:document.getElementById("permit-engineer")?.value,subcontractor:document.getElementById("permit-subcontractor")?.value,location:document.getElementById("permit-location")?.value,startTime:document.getElementById("permit-starttime")?.value,workersCount:document.getElementById("permit-workers")?.value,description:document.getElementById("permit-description")?.value,delayReason:document.getElementById("permit-delay-reason")?.value,delayDescription:document.getElementById("permit-delay-desc")?.value};if(!(t.projectName&&t.permitDate&&t.shift&&t.permitType&&t.location&&t.startTime&&t.workersCount&&t.description))return void showMessage(p,"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.",!1);const n=document.getElementById("permit-delay-group");if(!n||"none"===n.style.display||""===n.style.display||t.delayReason&&t.delayDescription)try{!function(e){showMessage(p,e?e.message:"ØªÙ….",!0),ge();const t=document.getElementById("permit-subcontractor-group");t&&(t.style.display="none")}(await de("savePermit",{permitObject:t,userInfo:currentUser}))}catch(e){!function(e){showMessage(p,e.message,!1)}(e)}else showMessage(p,"Ø¹ÙÙˆØ§Ù‹ØŒ Ø§Ù„ÙˆÙ‚Øª ØªØ¬Ø§ÙˆØ² 8 ØµØ¨Ø§Ø­Ø§Ù‹. ÙŠØ¬Ø¨ Ø°ÙƒØ± Ø³Ø¨Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ± ÙˆØªÙØ§ØµÙŠÙ„Ù‡.",!1)}));const ve=document.getElementById("permit-project"),he=document.getElementById("permit-requester"),fe=document.getElementById("permit-subcontractor-group"),Ee=document.getElementById("permit-subcontractor");async function Ie(){if(!ve||!he||!fe)return;const e=ve.value,t=he.value;if(e&&"Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„"===t){fe.style.display="block",Ee.innerHTML='<option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>',Ee.disabled=!0;try{const t=await de("getContractorsForProject",{projectName:e});t.contractors&&t.contractors.length>0?(Ee.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ --</option>',t.contractors.forEach((e=>{Ee.options.add(new Option(e,e))})),Ee.disabled=!1,Ee.required=!0):(Ee.innerHTML='<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</option>',Ee.disabled=!0,Ee.required=!1)}catch(e){Ee.innerHTML=`<option value="">Ø®Ø·Ø£: ${e.message}</option>`,Ee.disabled=!0}}else fe.style.display="none",Ee.innerHTML="",Ee.required=!1}async function we(){if(!currentUser)return;const e=document.getElementById("open-permits-list");e&&(e.innerHTML="<p>ØªØ­Ù…ÙŠÙ„...</p>");try{!function(e){const t=document.getElementById("open-permits-list");if(!t)return;if(e.permits&&0===e.permits.length)return void(t.innerHTML="<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµØ§Ø±ÙŠØ­ Ù…ÙØªÙˆØ­Ø©.</p>");e.permits?(t.innerHTML="",e.permits.forEach((e=>{const n=document.createElement("div");n.className="permit-card",n.innerHTML=`<div class="permit-info"><p><strong>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:</strong> ${e.project||"-"}</p><p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${e.type||"-"}</p><p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${e.date||"-"}</p><p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${e.description||"-"}</p><p><strong>ID:</strong> ${e.id||"-"}</p></div><button class="btn-close" data-id="${e.id}"><i class="fas fa-check-circle"></i> Ø¥ØºÙ„Ø§Ù‚</button>`;const o=n.querySelector(".btn-close");o&&o.addEventListener("click",(function(){confirm(`Ø¥ØºÙ„Ø§Ù‚ ${this.dataset.id}ØŸ`)&&async function(e){if(!e)return;try{!function(e){showMessage(u,e?e.message:"ØªÙ….",!0),we()}(await de("closePermit",{permitId:e}))}catch(e){!function(e){showMessage(u,e.message,!1)}(e)}}(this.dataset.id)})),t.appendChild(n)}))):t.innerHTML=`<p class="error-message" style="display:block;">${e&&e.message||"ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„."}</p>`}(await de("getOpenPermits",{userInfo:currentUser}))}catch(e){!function(e){const t=document.getElementById("open-permits-list");t&&(t.innerHTML=`<p class="error-message" style="display:block;">${e.message}</p>`)}(e)}}function be(){E&&currentUser&&initialData&&initialData.projects?(E.innerHTML='<option value="ALL_ACCESSIBLE">All Accessible</option>',initialData.projects.forEach((e=>E.innerHTML+=`<option value="${e}">${e}</option>`))):E&&(E.innerHTML='<option value="ALL_ACCESSIBLE">All</option><option disabled>Err</option>')}function Be(e,t){if(!e||0===e.length)return void(t.innerHTML='<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</p>');let n='<table class="results-table">\n          <thead>\n              <tr>\n                  <th>Ø§Ù„ÙƒÙˆØ¯</th>\n                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>\n                  <th>Ø§Ù„Ù…Ø³Ø¬Ù„</th>\n                  <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>\n                  <th>Ù…ØµØ¯Ø± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th> <th>Ø§Ù„ÙˆØµÙ</th>\n                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>\n              </tr>\n          </thead>\n          <tbody>';e.forEach((e=>{let t=e.date;try{const n=new Date(e.date);isNaN(n.getTime())||(t=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`)}catch(e){}n+=`<tr>\n              <td style="white-space:nowrap;"><strong>${e.id}</strong></td>\n              <td style="white-space:nowrap;">${t}</td>\n              <td style="color:#0056b3; font-weight:500;">${e.issuer||"-"}</td>\n              <td>${e.project}</td>\n\n              <td style="font-weight:bold;">${e.source||"-"}</td> <td class="desc-cell">${e.desc}</td>\n              <td><span class="badge ${"Open"===e.status?"bg-danger":"bg-success"}">${e.status}</span></td>\n          </tr>`})),n+="</tbody></table>",t.innerHTML=n}ve&&he&&(ve.addEventListener("change",Ie),he.addEventListener("change",Ie)),L?L.addEventListener("click",(async function(){if(!currentUser||!E)return;const e={selectedProject:E.value,selectedRequester:I.value||null,fromDate:w.value||null,toDate:b.value||null,showOpenOnly:B.checked};if(e.fromDate&&e.toDate&&new Date(e.fromDate)>new Date(e.toDate))showMessage(M,"'From' before 'To'.",!1);else{M&&(M.style.display="none"),$&&($.innerHTML="<p>Searching...</p>");try{!function(e){const t=document.getElementById("monitor-results-table");if(!t)return;if(!e||0===e.length)return void(t.innerHTML='<p style="text-align:center; padding:20px; color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµØ§Ø±ÙŠØ­ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø´Ø±ÙˆØ·.</p>');let n='\n        <table class="results-table" style="width:100%; font-size:0.9rem;">\n            <thead>\n                <tr>\n                    <th>Ø±Ù‚Ù… Ø§Ù„ØªØµØ±ÙŠØ­</th>\n                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>\n                    <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>\n                    <th>Ø§Ù„Ù†ÙˆØ¹</th>\n                    <th style="width:30%;">Ø§Ù„ÙˆØµÙ</th>\n                    <th>Ø§Ù„Ù…ØµØ¯Ø±</th>\n                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>\n                    <th>Ø¹Ø±Ø¶</th>\n                </tr>\n            </thead>\n            <tbody>';e.forEach((e=>{let t=e.permitDate||"-";const o=String(e.status||"").trim();let a="bg-secondary",s=o;"open"===o.toLowerCase()?(a="bg-danger",s="Ù…ÙØªÙˆØ­"):"closed"!==o.toLowerCase()&&"close"!==o.toLowerCase()||(a="bg-success",s="Ù…ØºÙ„Ù‚"),n+=`\n                <tr>\n                    <td style="font-weight:bold;">${e.id}</td>\n\n                    <td style="white-space:nowrap;">${t}</td>\n\n                    <td>${e.projectName||"-"}</td>\n\n                    <td>${e.permitType||"-"}</td>\n\n                    <td style="text-align:right; white-space: pre-wrap;">${e.description||"-"}</td>\n                    <td style="color:#0056b3; font-weight:bold;">${e.issuer||"-"}</td>\n                    <td><span class="badge ${a}">${s}</span></td>\n                    <td>\n                        <button type="button" class="btn-small btn-secondary" onclick="alert('ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©:\\nØ§Ù„Ø·Ø§Ù„Ø¨: ${e.requester||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}')">\n                            <i class="fas fa-eye"></i>\n                        </button>\n                    </td>\n                </tr>\n            `})),n+="</tbody></table>",t.innerHTML=n}((await de("searchPermits",{filters:e,userInfo:currentUser})).permits)}catch(e){showMessage(M,e.message,!1),$&&($.innerHTML="")}}})):console.error("#monitor-search-btn not found."),window.initKpiPage=async function(){console.log("ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…...");const e=document.getElementById("kpi-emp-name-display"),t=document.getElementById("kpi-emp-id-hidden"),n=document.getElementById("kpi-period-select"),o=document.getElementById("kpi-employee-jobtitle"),a=document.getElementById("kpi-guidelines-container"),s=document.getElementById("kpi-list-container"),c=document.getElementById("kpi-save-btn");if(e&&(e.value=""),t&&(t.value=""),o&&(o.innerHTML="",o.style.display="none"),a&&(a.style.display="block"),s&&(s.innerHTML="<p style='text-align:center; padding:20px; color:#777;'>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù ÙˆÙØªØ±Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…...</p>"),c&&(c.style.display="none"),n&&!n.value){const e=new Date;n.value=`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}`}try{const e=await de("getKpiInitData",{userInfo:currentUser,selectedPeriod:n.value});"success"===e.status&&(window.ppeEmployees=e.employees,evaluatedEmpIds=e.evaluatedIds)}catch(e){console.error("Error updating KPI data:",e)}};let Le=[],$e=[],Me=[],ke=[],Te=[];async function xe(){console.log("Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ù…Ø®Ø²Ù†..."),T.reset(),He(),Te=[],De();try{if(void 0===Le||0===Le.length){const e=await de("getInventoryInitData",{userInfo:currentUser});"success"===e.status&&(Le=e.locations,window.ppeEmployees=e.employees,Me=e.contractors,ke=e.ppeItems)}const e=(currentUser.projects||"").toString(),t="ALL"===e?Le:Le.filter((t=>e.includes(t)));Ne(z,t),Ne(A,t),Ne(N,Le),Ne(P,Le),Me&&Ne(R,Me)}catch(e){showMessage(Q,`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.message}`,!1)}}function He(){const e=k.value;if(x.style.display="none",H.style.display="none",S.style.display="none",j.style.display="none",X.disabled=!0,showMessage(Q,"",!0),showMessage(Z,"",!0),e){switch(j.style.display="block",X.disabled=!1,e){case"ØµØ±Ù":S.style.display="block",U.textContent="Ø§Ù„ØµØ±Ù Ù…Ù† Ù…Ø®Ø²Ù†:",checkRecipientTypeUI();break;case"Ù…Ø±ØªØ¬Ø¹":S.style.display="block",U.textContent="Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙÙŠ Ù…Ø®Ø²Ù†:",checkRecipientTypeUI();break;case"ØªØ­ÙˆÙŠÙ„":H.style.display="block";break;case"ØªÙˆØ±ÙŠØ¯":x.style.display="block",D&&(D.valueAsDate=new Date)}Ce()}}function Se(e){const t=document.getElementById("ppe-emp-list-container");t&&(0!==e.length?t.innerHTML=e.map((e=>`\n          <div class="ppe-cart-item" style="cursor:pointer; margin-bottom:8px;" \n               onclick="window.selectPpeEmployee('${e.id}', '${e.name}')">\n              <div style="text-align:right;">\n                  <span style="display:block; font-weight:700;">${e.name}</span>\n                  <small style="color:#666;">ID: ${e.id} | Project: ${e.project}</small>\n              </div>\n              <i class="fas fa-hand-pointer" style="color:#ccc;"></i>\n          </div>\n      `)).join(""):t.innerHTML='<p style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>')}async function je(){const e=z.value;if(e&&"Ù…Ù‚Ø§ÙˆÙ„"===O.value){R.innerHTML='<option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>',R.disabled=!0;try{const t=await de("getContractorsForProject",{projectName:e});R.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ --</option>',t.contractors&&t.contractors.length>0?(t.contractors.forEach((e=>{R.add(new Option(e,e))})),R.disabled=!1):R.innerHTML='<option value="">-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† --</option>'}catch(e){console.error(e),R.innerHTML='<option value="">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>'}}}async function Ce(){const e=k.value;let t=null;if("ØµØ±Ù"===e?t=z.value:"ØªØ­ÙˆÙŠÙ„"===e&&(t=A.value),K.innerHTML='<option value="">-- Ø§Ø®ØªØ± --</option>',K.disabled=!0,"Ù…Ø±ØªØ¬Ø¹"!==e&&"ØªÙˆØ±ÙŠØ¯"!==e)if(t){K.innerHTML='<option value="">â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†...</option>';try{const e=(await de("getAvailableItemsForLocation",{locationName:t})).availableItemIds;if(!e||0===e.length)return void(K.innerHTML='<option value="">ğŸš« Ø§Ù„Ù…Ø®Ø²Ù† ÙØ§Ø±Øº</option>');const n=ke.filter((t=>e.includes(t.id)));Ne(K,n,"id","name"),K.options[0].text=`-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‡Ù…Ø© (${n.length} ØµÙ†Ù Ù…ØªØ§Ø­) --`,K.disabled=!1}catch(e){console.error(e),K.innerHTML='<option value="">âš ï¸ Ø®Ø·Ø§Ø¡ ÙÙ‰ Ø§Ù„Ø§ØªØµØ§Ù„</option>',showMessage(Q,"ÙØ´Ù„ Ø¬Ù„Ø¨ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø®Ø²Ù†. Ø­Ø§ÙˆÙ„ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ§Ø®ØªÙŠØ§Ø±Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",!1)}}else K.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø²Ù† Ø£ÙˆÙ„Ø§Ù‹ --</option>';else if(ke&&ke.length>0)Ne(K,ke,"id","name"),K.disabled=!1;else{K.innerHTML='<option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...</option>';try{const e=await de("getInventoryInitData",{userInfo:currentUser});ke=e.ppeItems,Ne(K,ke,"id","name"),K.disabled=!1}catch(e){K.innerHTML='<option value="">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø§Øª</option>'}}}async function De(){0===Te.length?J.innerHTML="<p>Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù‡Ù…Ø§Øª...</p>":(J.innerHTML="",Te.forEach(((e,t)=>{const n=document.createElement("div");n.className="ppe-cart-item",n.innerHTML=`\n<span>${e.name} (<strong>Ø§Ù„ÙƒÙ…ÙŠØ©: ${e.qty}</strong>)</span>\n<button type="button" class="btn-small btn-danger" data-index="${t}">\n<i class="fas fa-trash"></i>\n</button>\n`,n.querySelector("button").addEventListener("click",(()=>{Te.splice(t,1),De()})),J.appendChild(n)})));const e=K.value,t=k.value;let n="";if("ØµØ±Ù"===t&&(n=z.value),"ØªØ­ÙˆÙŠÙ„"===t&&(n=A.value),!e||"ØµØ±Ù"!==t&&"ØªØ­ÙˆÙŠÙ„"!==t)W.textContent="";else{W.textContent="Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø±ØµÙŠØ¯...";try{const t=Te.find((t=>t.id===e)),o=t?t.qty:0,a=await de("checkStockBalance",{location:n,itemId:e}),s=parseFloat(a.balance)||0,c=s-o;W.textContent=`Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­ ÙÙŠ [${n}]: ${c} (Ù…Ù† Ø£ØµÙ„ ${s})`}catch(e){W.textContent="Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯."}}}function Ne(e,t,n=null,o=null){if(!e)return;const a=e.value;e.innerHTML='<option value="">-- Ø§Ø®ØªØ± --</option>',n&&o?t.forEach((t=>{e.options.add(new Option(t[o],t[n]))})):t.forEach((t=>{e.options.add(new Option(t,t))})),e.value=a}window.checkRecipientTypeUI=function(){const e=document.getElementById("ppe-recipient-type").value;document.getElementById("ppe-recipient-employee-group").style.display="Ù…ÙˆØ¸Ù"===e?"block":"none",document.getElementById("ppe-recipient-contractor-group").style.display="Ù…Ù‚Ø§ÙˆÙ„"===e?"block":"none","Ù…ÙˆØ¸Ù"===e?console.log("ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…: Ù…ÙˆØ¸Ù. Ø¨Ø§Ù†ØªØ¸Ø§Ø± ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±."):"Ù…Ù‚Ø§ÙˆÙ„"===e&&je()},window.openPpeEmpSelector=function(){const e=document.getElementById("ppe-recipient-location").value,t=document.getElementById("ppe-show-all-emp").checked;if(!e&&!t)return void alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø®Ø²Ù† Ø£ÙˆÙ„Ø§Ù‹ Ø£Ùˆ ØªÙØ¹ÙŠÙ„ Ø®ÙŠØ§Ø± 'Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„'");if(!window.ppeEmployees||0===window.ppeEmployees.length)return void alert("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†... Ø§Ù†ØªØ¸Ø± Ø«Ø§Ù†ÙŠØ© ÙˆØ¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");document.getElementById("ppe-emp-modal").style.display="flex",document.getElementById("ppe-emp-search-box").value="",document.getElementById("ppe-emp-search-box").focus();Se(t?window.ppeEmployees:window.ppeEmployees.filter((t=>t.project===e)))},window.closePpeEmpSelector=function(){document.getElementById("ppe-emp-modal").style.display="none"},window.filterPpeEmpList=function(){const e=document.getElementById("ppe-emp-search-box").value.toLowerCase(),t=document.getElementById("ppe-recipient-location").value,n=document.getElementById("ppe-show-all-emp").checked;if(!window.ppeEmployees)return;Se((n?window.ppeEmployees:window.ppeEmployees.filter((e=>e.project===t))).filter((t=>t.name&&t.name.toLowerCase().includes(e)||t.id&&t.id.toString().includes(e))))},window.selectPpeEmployee=function(e,t){document.getElementById("ppe-emp-name-display").value=t,document.getElementById("ppe-emp-id-hidden").value=e,window.closePpeEmpSelector()},k&&k.addEventListener("change",He),z&&z.addEventListener("change",(()=>{document.getElementById("ppe-emp-name-display").value="",document.getElementById("ppe-emp-id-hidden").value="",je(),Ce()})),A&&A.addEventListener("change",Ce),O&&O.addEventListener("change",checkRecipientTypeUI),F&&F.addEventListener("click",(async function(){const e=q.value;if(!e||e.length<5)showMessage(Q,"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‚ÙˆÙ…ÙŠ/ID ØµØ­ÙŠØ­.",!1);else{showMessage(Q,"",!0),_.value="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...",_.disabled=!0;try{const t=await de("getRecipientByNID",{nationalId:e});"found"===t.status?(_.value=t.name,_.disabled=!0,R.value=t.contractor):"not_found"===t.status&&(_.value="",_.placeholder="Ù…Ø³ØªÙ„Ù… Ø¬Ø¯ÙŠØ¯ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„",_.disabled=!1,_.focus())}catch(e){showMessage(Q,e.message,!1),_.value=""}}})),Y&&Y.addEventListener("click",(async function(){const e=K.value,t=parseInt(V.value),n=k.value;showMessage(Q,"",!0);const o=Y.innerHTML;Y.disabled=!0,Y.innerHTML='<i class="fas fa-spinner fa-spin"></i>';try{if(!e||!t||t<=0)throw new Error("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù‡Ù…Ø© ÙˆÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©.");if("ØµØ±Ù"===n||"ØªØ­ÙˆÙŠÙ„"===n){let o=null;if("ØµØ±Ù"===n&&(o=z.value),"ØªØ­ÙˆÙŠÙ„"===n&&(o=A.value),!o)throw new Error("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…ØµØ¯Ø± (Ø§Ù„ØµØ±Ù Ù…Ù† / Ù…Ù† Ù…Ø®Ø²Ù†) Ø£ÙˆÙ„Ø§Ù‹.");const a=Te.find((t=>t.id===e)),s=t+(a?a.qty:0),c=await de("checkStockBalance",{location:o,itemId:e}),l=parseFloat(c.balance)||0;if(s>l)throw new Error(`Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù! Ø§Ù„Ù…ØªØ§Ø­: ${l}. Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø¨Ø§Ù„Ø³Ù„Ø©): ${s}.`)}const o=K.options[K.selectedIndex].text,a=Te.find((t=>t.id===e));a?a.qty+=t:Te.push({id:e,name:o,qty:t}),De(),K.value="",V.value=1}catch(e){showMessage(Q,e.message,!1)}finally{Y.disabled=!1,Y.innerHTML=o}})),K&&K.addEventListener("change",De),T&&T.addEventListener("submit",(async function(e){e.preventDefault(),X.disabled=!0,X.innerHTML='<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...',showMessage(Q,"",!0),showMessage(Z,"",!0);try{const e=k.value,t={transactionType:e,notes:G?G.value:"",items:Te,locations:{},recipient:{},supplier:{}};if(0===Te.length)throw new Error("ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");if("ØµØ±Ù"===e||"Ù…Ø±ØªØ¬Ø¹"===e){const n=z.value;if(!n)throw new Error("ØµØ±Ù"===e?"ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø®Ø²Ù† (Ø§Ù„ØµØ±Ù Ù…Ù†).":"ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø®Ø²Ù† (Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙÙŠ).");"ØµØ±Ù"===e?t.locations.source=n:t.locations.destination=n;const o=O.value;if(t.recipient.type=o,"Ù…ÙˆØ¸Ù"===o){const e=document.getElementById("ppe-emp-id-hidden").value,n=document.getElementById("ppe-emp-name-display").value;if(!e||!n)throw new Error("ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.");t.recipient.id=e,t.recipient.name=n,t.recipient.company="Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠ"}else{if("Ù…Ù‚Ø§ÙˆÙ„"!==o)throw new Error("ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù….");{const e=R.value,n=q.value,o=_.value;if(!e||!n||!o)throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù†Ø§Ù‚ØµØ© (Ø§Ù„Ø´Ø±ÙƒØ©ØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠØŒ Ø§Ù„Ø§Ø³Ù…).");t.recipient.id=n,t.recipient.name=o,t.recipient.company=e,t.recipient.isNew=!_.disabled}}}else if("ØªÙˆØ±ÙŠØ¯"===e){const e=N.value,n=C.value;if(!e)throw new Error("ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø³ØªÙ„Ù… Ù„Ù„ØªÙˆØ±ÙŠØ¯.");if(!n)throw new Error("ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯.");t.locations.destination=e,t.supplier.name=n}else if("ØªØ­ÙˆÙŠÙ„"===e){const e=A.value,n=P.value;if(!e||!n)throw new Error("ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø­ÙˆÙ„ Ù…Ù†Ù‡ ÙˆØ§Ù„Ù…Ø­ÙˆÙ„ Ø¥Ù„ÙŠÙ‡.");if(e===n)throw new Error("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø®Ø²Ù†.");t.locations.source=e,t.locations.destination=n}const n=await de("savePpeTransaction",{trx:t,userInfo:currentUser});showMessage(Z,n.message,!0),setTimeout((()=>{Z.style.display="none",xe()}),2e3)}catch(e){showMessage(Q,e.message,!1)}finally{X.disabled=!1,X.innerHTML='<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ©'}})),te&&te.addEventListener("click",(async function(){const e=ee.value;if(e){showMessage(oe,"",!0),ne.innerHTML="<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...</p>";try{const t=await de("getProjectStockReport",{locationName:e,userInfo:currentUser});t.report&&t.report.length>0?function(e,t){let n=`<h3 style="text-align:center;">Ø±ØµÙŠØ¯: ${t}</h3>\n<table class="results-table">\n<thead>\n<tr>\n<th>Ø§Ù„ØªØµÙ†ÙŠÙ (Category)</th>\n<th>ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‡Ù…Ø© (Item ID)</th>\n<th>Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø©</th>\n<th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©</th>\n</tr>\n</thead>\n<tbody>`;e.forEach((e=>{n+=`<tr>\n<td>${e.category||"ØºÙŠØ± Ù…ØµÙ†Ù"}</td>\n<td>${e.itemId}</td>\n<td>${e.itemName}</td>\n<td style="font-weight:bold; text-align:center;">${e.balance}</td>\n</tr>`})),n+="</tbody></table>",ne.innerHTML=n}(t.report,e):ne.innerHTML=`<p>Ø§Ù„Ù…Ø®Ø²Ù† [${e}] ÙØ§Ø±Øº Ø­Ø§Ù„ÙŠØ§Ù‹.</p>`}catch(e){showMessage(oe,e.message,!1),ne.innerHTML=""}}else showMessage(oe,"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹.",!1)}));const Ae=document.getElementById("trn-date"),Pe=document.getElementById("trn-time"),Ue=document.getElementById("trn-trainer"),ze=document.getElementById("trn-project"),Oe=document.getElementById("trn-topic"),Re=document.getElementById("trn-attendee-type"),qe=document.getElementById("trn-emp-group"),Fe=document.getElementById("trn-cont-group"),_e=document.getElementById("trn-emp-select"),Ke=document.getElementById("trn-show-all-emp"),Ve=document.getElementById("trn-cont-company"),Ye=document.getElementById("trn-cont-nid"),We=document.getElementById("trn-cont-search-btn"),Je=document.getElementById("trn-cont-name"),Ge=document.getElementById("trn-add-btn"),Xe=document.getElementById("trn-add-msg"),Qe=document.getElementById("trn-list-container"),Ze=document.getElementById("trn-count"),et=document.getElementById("training-form"),tt=document.getElementById("trn-save-btn"),nt=document.getElementById("trn-save-msg"),ot=document.getElementById("trn-notes");let at=!1;function st(){Ze&&(Ze.textContent=Xa.length),0===Xa.length?Qe.innerHTML='<p style="text-align: center; color: #777;">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©...</p>':(Qe.innerHTML="",Xa.forEach(((e,t)=>{const n=document.createElement("div");n.className="ppe-cart-item",n.innerHTML=`\n                  <span><small>[${e.type}]</small> <strong>${e.name}</strong> (${e.company})</span>\n                  <button type="button" class="btn-small btn-danger" onclick="removeTrnItem(${t})">X</button>\n              `,Qe.appendChild(n)})))}window.openEmpSelector=function(){const e=document.getElementById("trn-project").value,t=document.getElementById("trn-show-all-emp").checked;if(!window.ppeEmployees||0===window.ppeEmployees.length)return void alert("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø«Ø§Ù†ÙŠØ©...");if(!e&&!t)return void alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹ Ø£Ùˆ ØªÙØ¹ÙŠÙ„ Ø®ÙŠØ§Ø± 'Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†'");document.getElementById("emp-selector-modal").style.display="flex",document.getElementById("emp-search-box").value="";renderEmployeesInModal(t?window.ppeEmployees:window.ppeEmployees.filter((t=>t.project===e)))},window.handleTrnProjectChange=async function(){const e=document.getElementById("trn-project").value,t=document.getElementById("trn-cont-company"),n=document.getElementById("trn-cont-name"),o=document.getElementById("trn-cont-nid");if(n&&(n.value=""),o&&(o.value=""),"function"==typeof window.resetEmpSelector&&window.resetEmpSelector(),e){t.innerHTML="<option>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù‚Ø§ÙˆÙ„ÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹...</option>";try{const n=await de("getContractorsForProject",{projectName:e});"success"===n.status?ie(t,n.contractors):t.innerHTML='<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</option>'}catch(e){console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ù‚Ø§ÙˆÙ„ÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:",e),t.innerHTML='<option value="">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>'}}else t.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹ --</option>'},window.removeTrnItem=e=>{Xa.splice(e,1),st()},et&&et.addEventListener("submit",(async e=>{if(e.preventDefault(),0===Xa.length)return void showMessage(Xe,"Ø£Ø¶Ù Ø­Ø¶ÙˆØ± Ø£ÙˆÙ„Ø§Ù‹",!1);const t={project:ze.value,topic:Oe.value,attendees:Xa,notes:ot.value};if(t.project&&t.topic){tt.disabled=!0,tt.textContent="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";try{const e=await de("saveTrainingSession",{sessionData:t,userInfo:currentUser});showMessage(nt,e.message,!0),nt&&(nt.style.whiteSpace="pre-wrap"),Xa=[],st(),et.reset(),Ue&&(Ue.value=currentUser.username);const n=new Date;Ae&&(Ae.value=n.toLocaleDateString("en-CA")),Pe&&(Pe.value=n.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}))}catch(e){showMessage(nt,e.message,!1)}finally{tt.disabled=!1,tt.textContent="Ø­ÙØ¸ Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨"}}else showMessage(Xe,"Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ§Ù„Ù…ÙˆØ¶ÙˆØ¹",!1)})),ze&&ze.addEventListener("change",handleTrnProjectChange),Ke&&Ke.addEventListener("change",(function(){const e=ze.value,t=Ke.checked;if(_e.innerHTML='<option value="">-- Ø§Ø®ØªØ± --</option>',!e&&!t)return;let n=[];n=t?$e:$e.filter((t=>t.project===e)),n.forEach((e=>{const n=new Option(`${e.name} (${t?e.project:""})`,e.id);n.dataset.name=e.name,n.dataset.company=e.company||"Ø§Ù„Ø´Ø±ÙƒØ©",_e.add(n)}))})),Re&&Re.addEventListener("change",(()=>{const e="Ù…ÙˆØ¸Ù"===Re.value;qe&&(qe.style.display=e?"block":"none"),Fe&&(Fe.style.display=e?"none":"block")})),Ge&&Ge.addEventListener("click",(async function(){const e=document.getElementById("trn-attendee-type").value;let t={type:e};if("Ù…ÙˆØ¸Ù"===e){const e=document.getElementById("trn-emp-name-display").value,n=document.getElementById("trn-emp-id-hidden").value;if(!e)return void alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹");t.id=n,t.name=e,t.company="Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠ"}else{const e=Ye.value,n=Je.value,o=Ve.value;if(!e||!n||!o)return void showMessage(Xe,"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù†Ø§Ù‚ØµØ©",!1);const a=!0===Je.disabled||!0===Ye.readOnly;if(!a)try{const t=await de("getRecipientByNID",{nationalId:e});if(t&&"found"===t.status)return void alert(`Ø¹ÙÙˆØ§Ù‹! Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ (${e}) Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ø§Ø³Ù…: [${t.name}]\nØ§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø³Ø­ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªÙˆØ¨ ÙˆØ§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©.`)}catch(e){console.error("Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ:",e)}t.id=e,t.name=n,t.company=o,t.isNew=!a}Xa.find((e=>e.id===t.id))?showMessage(Xe,"Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ Ù…Ø¶Ø§Ù Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©",!1):(Xa.push(t),st(),"Ù…Ù‚Ø§ÙˆÙ„"===e&&(Ye.value="",Je.value="",Je.disabled=!1,Ye.readOnly=!1,Ye.style.backgroundColor="#fff"))})),We&&We.addEventListener("click",(async function(){const e=Ye.value;if(e){Je.value="Ø¨Ø­Ø«...",Je.disabled=!0;try{const t=await de("getRecipientByNID",{nationalId:e});"found"===t.status?(Je.value=t.name,Je.disabled=!0,Ve.value=t.contractor,showMessage(Xe,"Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…Ù‰ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« ÙÙ‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø³Ù…Ø§Ø¡",!1),alert("ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…Ù‰ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ø§Ø³Ù… ( "+t.name+" ). Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©.")):(Je.value="",Je.placeholder="Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯...",Je.disabled=!1,Je.focus(),showMessage(Xe,"Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¢Ù†.",!0))}catch(e){Je.value="",Je.disabled=!1,showMessage(Xe,"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",!1)}}}));const ct=document.getElementById("obs-form"),lt=document.getElementById("obs-view-date"),rt=(document.getElementById("obs-view-time"),document.getElementById("obs-project")),it=document.getElementById("obs-hazard"),dt=document.getElementsByName("obs-resp"),mt=document.getElementById("obs-contractor-div"),pt=document.getElementById("obs-contractor-select"),ut=document.getElementById("obs-action-text"),yt=document.getElementById("obs-action-date"),gt=document.getElementById("obs-add-action-btn"),vt=document.getElementById("obs-actions-list"),ht=document.getElementById("obs-save-btn"),ft=document.getElementById("obs-save-msg"),Et=document.getElementById("mon-obs-project"),It=document.getElementById("mon-obs-from"),wt=document.getElementById("mon-obs-to"),bt=document.getElementById("mon-obs-open"),Bt=document.getElementById("mon-obs-btn"),Lt=document.getElementById("mon-obs-table");let $t=[];async function Mt(){console.log("Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª...");const e=new Date,t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;lt&&(lt.value=t);const n=document.getElementById("obs-issuer");if(n&&currentUser&&(n.value=currentUser.username),rt&&rt.options.length<=1)if(void 0!==Le&&Le.length>0){const e=(currentUser.projects||"").toString();let t=Le;"ALL"!==e&&(t=Le.filter((t=>e.includes(t)))),ie(rt,t)}else try{const e=await de("getInventoryInitData",{userInfo:currentUser});if("success"===e.status){Le=e.locations;const t=(currentUser.projects||"").toString();let n=e.locations;"ALL"!==t&&(n=e.locations.filter((e=>t.includes(e)))),ie(rt,n)}}catch(e){console.error(e)}if(it&&it.options.length<=1){it.innerHTML="<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>";try{const e=await de("getHazardsList",{});"success"===e.status?ie(it,e.hazards):it.innerHTML='<option value="">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>'}catch(e){it.innerHTML='<option value="">Ø®Ø·Ø£ Ø§ØªØµØ§Ù„</option>'}}$t=[],Tt(),document.getElementById("resp-elsewedy")&&(document.getElementById("resp-elsewedy").checked=!0),kt()}function kt(){let e=!1;const t=document.querySelector('input[name="obs-resp"]:checked');if(t&&"Ù…Ù‚Ø§ÙˆÙ„"===t.value&&(e=!0),mt&&(mt.style.display=e?"block":"none"),e){const e=rt.value;e?async function(e){pt.innerHTML="<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>",pt.disabled=!0;try{const t=await de("getContractorsForProject",{projectName:e});t.contractors&&t.contractors.length>0?(ie(pt,t.contractors),pt.disabled=!1):pt.innerHTML='<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</option>'}catch(e){pt.innerHTML='<option value="">Ø®Ø·Ø£</option>',console.error(e)}}(e):(pt.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹ --</option>',pt.disabled=!0)}else pt.innerHTML='<option value="">-- Ø§Ø®ØªØ± --</option>',pt.value=""}function Tt(){vt&&(0===$t.length?vt.innerHTML='<p style="color:#777; font-size:0.9em;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ø¶Ø§ÙØ©.</p>':(vt.innerHTML="",$t.forEach(((e,t)=>{const n=document.createElement("div");n.className="ppe-cart-item",n.innerHTML=`<span>${e.text} <small>(${e.targetDate})</small></span> <button type="button" class="btn-small btn-danger" onclick="remObsAction(${t})">X</button>`,vt.appendChild(n)}))))}window.remObsAction=e=>{$t.splice(e,1),Tt()},ct&&ct.addEventListener("submit",(async e=>{e.preventDefault();const t={project:rt.value,locationDetail:document.getElementById("obs-location-detail").value,source:document.getElementById("obs-source").value,type:document.getElementById("obs-type").value,hazard:it.value,description:document.getElementById("obs-desc").value,responsibility:document.querySelector('input[name="obs-resp"]:checked').value,actions:$t};if("Ù…Ù‚Ø§ÙˆÙ„"===t.responsibility){if(t.companyName=pt.value,!t.companyName)return void alert("Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„")}else t.companyName="Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠ";if(0!==t.actions.length||confirm("Ù„Ù… ØªØ¶Ù Ø£ÙŠ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªØµØ­ÙŠØ­ÙŠØ©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­ÙØ¸ Ø¨Ø¯ÙˆÙ† Ø¥Ø¬Ø±Ø§Ø¡Ø§ØªØŸ")){ht.disabled=!0,ht.innerHTML='<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';try{const e=await de("saveObservationFull",{obsData:t,userInfo:currentUser});showMessage(ft,e.message,!0),ct.reset(),Mt()}catch(e){alert("Ø®Ø·Ø£: "+e.message)}finally{ht.disabled=!1,ht.innerHTML='<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©'}}})),rt&&rt.addEventListener("change",(()=>{kt()})),dt&&dt.forEach((e=>e.addEventListener("change",kt))),gt&&gt.addEventListener("click",(function(){const e=ut.value,t=yt.value;e&&t?($t.push({text:e,targetDate:t}),Tt(),ut.value="",yt.value=""):alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®")}));const xt=document.getElementById("my-obs-list"),Ht=document.getElementById("refresh-obs-btn");async function St(){if(xt){xt.innerHTML='<div class="loader-small">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø§Ù„Ù…ÙØªÙˆØ­Ø©...</div>';try{const e=await de("getUserOpenObservations",{userInfo:currentUser});"success"===e.status?function(e){if(0===e.length)return void(xt.innerHTML='<p style="text-align:center; padding:20px;">ğŸ‰ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…ÙØªÙˆØ­Ø©ØŒ ÙƒÙ„Ù‡ ØªÙ…Ø§Ù…!</p>');let t='\n      <table class="results-table">\n        <thead>\n            <tr>\n                <th>Ø§Ù„ÙƒÙˆØ¯</th>\n                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th> <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>\n                <th>Ù…ØµØ¯Ø± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>\n                <th>Ø§Ù„ÙˆØµÙ</th>\n                <th>Ø¥Ø¬Ø±Ø§Ø¡</th>\n            </tr>\n        </thead>\n        <tbody>';e.forEach((e=>{let n=e.date;try{const t=new Date(e.date);isNaN(t.getTime())||(n=t.toLocaleDateString("en-GB"))}catch(e){}t+=`\n        <tr>\n            <td style="font-weight:bold;">${e.id}</td>\n            <td>${n}</td> <td>${e.project}<br><small style="color:#666;">${e.type}</small></td>\n\n            <td style="color:#0056b3;">${e.source||"-"}</td>\n\n            <td title="${e.desc}">${e.desc.substring(0,50)}${e.desc.length>50?"...":""}</td>\n            <td>\n                <button class="btn-small btn-danger" onclick="handleCloseObs('${e.id}')">\n                    Ø¥ØºÙ„Ø§Ù‚\n                </button>\n            </td>\n        </tr>`})),t+="</tbody></table>",xt.innerHTML=t}(e.observations):xt.innerHTML=`<p class="error-message">${e.message}</p>`}catch(e){xt.innerHTML=`<p class="error-message">${e.message}</p>`}}}window.handleCloseObs=async function(e){const t=prompt("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Ø£Ùˆ Ù…Ø§ ØªÙ… ØªÙ†ÙÙŠØ°Ù‡):");if(null!==t)if(""!==t.trim()){le("Ø¬Ø§Ø±ÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©...");try{const n=await de("closeObservation",{obsId:e,closingNote:t});alert(n.message),St()}catch(e){alert("Ø®Ø·Ø£: "+e.message)}finally{re()}}else alert("ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø¥ØºÙ„Ø§Ù‚.")},Ht&&Ht.addEventListener("click",St);const jt=document.getElementById("haz-form"),Ct=(document.getElementById("haz-view-date"),document.getElementById("haz-view-time"),document.getElementById("haz-issuer"),document.getElementById("haz-project")),Dt=document.getElementById("haz-reporter-type"),Nt=document.getElementById("haz-emp-group"),At=document.getElementById("haz-cont-group"),Pt=(document.getElementById("haz-reporter-emp"),document.getElementById("haz-reporter-company")),Ut=document.getElementById("haz-reporter-nid"),zt=document.getElementById("haz-nid-search-btn"),Ot=document.getElementById("haz-reporter-name"),Rt=document.getElementById("haz-result"),qt=document.getElementById("haz-action-text"),Ft=document.getElementById("haz-action-date"),_t=document.getElementById("haz-add-action-btn"),Kt=document.getElementById("haz-actions-list"),Vt=document.getElementById("haz-save-btn"),Yt=document.getElementById("haz-save-msg"),Wt=document.getElementById("mon-haz-project"),Jt=document.getElementById("mon-haz-from"),Gt=document.getElementById("mon-haz-to"),Xt=document.getElementById("mon-haz-open"),Qt=document.getElementById("mon-haz-btn"),Zt=document.getElementById("mon-haz-table"),en=document.getElementById("my-haz-list"),tn=document.getElementById("refresh-haz-btn");let nn=[];async function on(){console.log("Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ ØµÙØ­Ø© ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø®Ø·Ø±..."),document.getElementById("haz-emp-name-display")&&(document.getElementById("haz-emp-name-display").value=""),document.getElementById("haz-emp-id-hidden")&&(document.getElementById("haz-emp-id-hidden").value="");const e=new Date,t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;if(document.getElementById("haz-view-date")&&(document.getElementById("haz-view-date").value=t),Ct&&Ct.options.length<=1)if(void 0!==Le&&Le.length>0){const e=(currentUser.projects||"").toString(),t="ALL"===e?Le:Le.filter((t=>e.includes(t)));ie(Ct,t)}else de("getInventoryInitData",{userInfo:currentUser}).then((e=>{if("success"===e.status){Le=e.locations,$e=e.employees,Me=e.contractors;const t=(currentUser.projects||"").toString(),n="ALL"===t?e.locations:e.locations.filter((e=>t.includes(e)));ie(Ct,n)}}));if(document.getElementById("haz-issuer")&&currentUser&&(document.getElementById("haz-issuer").value=currentUser.username),!window.ppeEmployees||0===window.ppeEmployees.length)try{const e=await de("getInventoryInitData",{userInfo:currentUser});"success"===e.status&&(window.ppeEmployees=e.employees)}catch(e){console.error("Error loading employees for Hazard:",e)}Rt&&Rt.options.length<=1&&(Rt.innerHTML="<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>",de("getHazardsList",{}).then((e=>{"success"===e.status?ie(Rt,e.hazards):Rt.innerHTML='<option value="">ÙØ´Ù„</option>'}))),nn=[],ln(),Dt&&(Dt.value="Ù…ÙˆØ¸Ù",an())}function an(){const e=Dt.value;Nt.style.display="Ù…ÙˆØ¸Ù"===e?"block":"none",At.style.display="Ù…Ù‚Ø§ÙˆÙ„"===e?"block":"none","Ù…Ù‚Ø§ÙˆÙ„"===e&&cn()}function sn(e){document.getElementById("haz-emp-list-container").innerHTML=0===e.length?'<p style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>':e.map((e=>`\n              <div class="ppe-cart-item" style="cursor:pointer; margin-bottom:8px;" \n                   onclick="window.selectHazEmployee('${e.id}', '${e.name}')">\n                  <div style="text-align:right;">\n                      <span style="display:block; font-weight:700;">${e.name}</span>\n                      <small style="color:#666;">ID: ${e.id} | Project: ${e.project}</small>\n                  </div>\n                  <i class="fas fa-search-location" style="color:#ccc;"></i>\n              </div>`)).join("")}async function cn(){const e=Ct.value;if(e){Pt.innerHTML="<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>";try{const t=await de("getContractorsForProject",{projectName:e});ie(Pt,t.contractors)}catch(e){}}}function ln(){Kt&&(Kt.innerHTML=nn.map(((e,t)=>`<div>${e.text} (${e.targetDate}) <button onclick="remHazAct(${t})">X</button></div>`)).join(""))}async function rn(){if(en){en.innerHTML="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";try{const e=await de("getUserOpenHazards",{userInfo:currentUser});let t='<table class="results-table"><thead><tr><th>ID</th><th>Project</th><th>Desc</th><th>Action</th></tr></thead><tbody>';e.hazards&&e.hazards.length>0?(e.hazards.forEach((e=>{t+=`<tr><td>${e.id}</td><td>${e.project}</td><td title="${e.desc}">${e.desc.substring(0,30)}...</td>\n                  <td><button class="btn-small btn-danger" onclick="handleCloseHaz('${e.id}')">Ø¥ØºÙ„Ø§Ù‚</button></td></tr>`})),t+="</tbody></table>",en.innerHTML=t):en.innerHTML="Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…ÙØªÙˆØ­Ø©."}catch(e){en.innerHTML=e.message}}}function dn(e){e&&initialData&&(e.innerHTML='<option value="ALL_ACCESSIBLE">Ø§Ù„ÙƒÙ„</option>',initialData.projects&&initialData.projects.forEach((t=>e.add(new Option(t,t)))))}function Be(e,t){if(!e||0===e.length)return void(t.innerHTML='<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</p>');let n='<table class="results-table">\n          <thead>\n              <tr>\n                  <th>Ø§Ù„ÙƒÙˆØ¯</th>\n                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>\n                  <th>Ø§Ù„Ù…Ø³Ø¬Ù„</th>\n                  <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>\n                  <th>Ù…ØµØ¯Ø± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>\n                  <th>Ø§Ù„ÙˆØµÙ</th>\n                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>\n              </tr>\n          </thead>\n          <tbody>';e.forEach((e=>{let t=e.date;try{const n=new Date(e.date);isNaN(n.getTime())||(t=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`)}catch(e){}n+=`<tr>\n              <td style="white-space:nowrap;"><strong>${e.id}</strong></td>\n              <td style="white-space:nowrap;">${t}</td>\n              <td style="color:#0056b3; font-weight:500;">${e.issuer||"-"}</td>\n              <td>${e.project}</td>\n\n              <td style="font-weight:bold;">${e.source||"-"}</td> <td class="desc-cell">${e.desc}</td>\n              <td><span class="badge ${"Open"===e.status?"bg-danger":"bg-success"}">${e.status}</span></td>\n          </tr>`})),n+="</tbody></table>",t.innerHTML=n}window.openHazEmpSelector=function(){const e=document.getElementById("haz-project").value,t=document.getElementById("haz-show-all-emp").checked;if(!e&&!t)return void alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹");if(!window.ppeEmployees||0===window.ppeEmployees.length)return void alert("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");document.getElementById("haz-emp-modal").style.display="flex",document.getElementById("haz-emp-search-box").value="",document.getElementById("haz-emp-search-box").focus();sn(t?window.ppeEmployees:window.ppeEmployees.filter((t=>t.project===e)))},window.closeHazEmpSelector=function(){document.getElementById("haz-emp-modal").style.display="none"},window.filterHazEmpList=function(){const e=document.getElementById("haz-emp-search-box").value.toLowerCase(),t=document.getElementById("haz-project").value;sn((document.getElementById("haz-show-all-emp").checked?window.ppeEmployees:window.ppeEmployees.filter((e=>e.project===t))).filter((t=>t.name.toLowerCase().includes(e)||t.id.toString().includes(e))))},window.selectHazEmployee=function(e,t){document.getElementById("haz-emp-name-display").value=t,document.getElementById("haz-emp-id-hidden").value=e,window.closeHazEmpSelector()},window.remHazAct=e=>{nn.splice(e,1),ln()},jt&&jt.addEventListener("submit",(async e=>{e.preventDefault();const t={project:Ct.value,description:document.getElementById("haz-desc").value,hazardResult:Rt.value,reporter:{type:Dt.value},actions:nn};if("Ù…ÙˆØ¸Ù"===t.reporter.type){const e=document.getElementById("haz-emp-id-hidden").value,n=document.getElementById("haz-emp-name-display").value;if(!e||!n)return void alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø®Ø§Ù†Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©");window.ppeEmployees.find((t=>t.id==e));t.reporter.id=e,t.reporter.name=n,t.reporter.company="Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠ"}else if(t.reporter.id=Ut.value,t.reporter.name=Ot.value,t.reporter.company=Pt.value,t.reporter.isNew=!Ot.disabled,!t.reporter.id||!t.reporter.name||!t.reporter.company)return void alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù†Ø§Ù‚ØµØ©");Vt.disabled=!0,Vt.textContent="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";try{const e=await de("saveHazardFull",{hazData:t,userInfo:currentUser});showMessage(Yt,e.message,!0),jt.reset(),on()}catch(e){alert(e.message)}finally{Vt.disabled=!1,Vt.textContent="Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"}})),Ct&&Ct.addEventListener("change",(()=>{cn()})),Dt&&Dt.addEventListener("change",an),zt&&zt.addEventListener("click",(async function(){const e=Ut.value;if(e){Ot.value="Ø¨Ø­Ø«...",Ot.disabled=!0;try{const t=await de("getRecipientByNID",{nationalId:e});"found"===t.status?(Ot.value=t.name,Pt.value=t.contractor,Ot.disabled=!0):(Ot.value="",Ot.disabled=!1,Ot.focus())}catch(e){Ot.value="",Ot.disabled=!1}}})),_t&&_t.addEventListener("click",(function(){qt.value&&Ft.value&&(nn.push({text:qt.value,targetDate:Ft.value}),ln(),qt.value="",Ft.value="")})),window.handleCloseHaz=async function(e){const t=prompt("Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚:");if(null!==t)try{const n=await de("closeHazard",{hazId:e,closingNote:t});alert(n.message),rn()}catch(e){alert(e.message)}},tn&&tn.addEventListener("click",rn),Bt&&Bt.addEventListener("click",(async function(){Lt.innerHTML="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";const e={project:Et.value,fromDate:It.value,toDate:wt.value,openOnly:bt.checked};try{const t=await de("searchObservations",{filters:e,userInfo:currentUser});Be(t.data,Lt)}catch(e){Lt.innerHTML=e.message}})),Qt&&Qt.addEventListener("click",(async function(){Zt.innerHTML="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";const e={project:Wt.value,fromDate:Jt.value,toDate:Gt.value,openOnly:Xt.checked};try{const t=await de("searchHazards",{filters:e,userInfo:currentUser});Be(t.data,Zt)}catch(e){Zt.innerHTML=e.message}}));const mn=document.getElementById("cont-eval-project"),pn=document.getElementById("cont-eval-month"),un=document.getElementById("cont-eval-contractor"),yn=document.getElementById("cont-eval-load-btn"),gn=document.getElementById("cont-kpi-container"),vn=document.getElementById("cont-eval-footer"),hn=document.getElementById("cont-total-score"),fn=document.getElementById("cont-max-score"),En=document.getElementById("cont-eval-form");let In=[];function wn(){let e=0;document.querySelectorAll(".cont-score").forEach((t=>{let n=parseFloat(t.value);isNaN(n)&&(n=0),e+=n})),hn.textContent=e}En&&En.addEventListener("submit",(async e=>{if(e.preventDefault(),!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŸ"))return;const t=[];let n=!1,o=0;if(document.querySelectorAll(".cont-score").forEach((e=>{const a=parseFloat(e.value),s=parseFloat(e.dataset.max);a<0||a>s?(e.style.borderColor="red",n=!0):(e.style.borderColor="",t.push({id:e.dataset.id,score:a||0}),o+=a||0)})),n)return void alert("ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰).");const a={project:mn.value,contractor:un.value,month:pn.value,totalScore:o,maxScore:parseFloat(fn.textContent),scores:t},s=En.querySelector('button[type="submit"]');s.disabled=!0,s.textContent="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";try{const e=await de("saveContractorEval",{evalData:a,userInfo:currentUser});alert(e.message),gn.innerHTML="",vn.style.display="none"}catch(e){alert(e.message)}finally{s.disabled=!1,s.textContent="Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…"}})),mn&&mn.addEventListener("change",(async function(){const e=mn.value;if(e){un.innerHTML="<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>",un.disabled=!0;try{const t=await de("getContractorsForProject",{projectName:e});t.contractors&&t.contractors.length>0?(ie(un,t.contractors),un.disabled=!1):un.innerHTML='<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</option>'}catch(e){un.innerHTML="<option>Ø®Ø·Ø£</option>"}}})),yn&&yn.addEventListener("click",(async function(){const e=mn.value,t=un.value,n=pn.value;if(e&&t&&n){gn.innerHTML='<div class="loader-small">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…...</div>',vn.style.display="none";try{const e=await de("getContractorKPIs",{month:n});"success"===e.status&&e.kpis.length>0?function(e){In=e,gn.innerHTML="";let t=0;e.forEach((e=>{t+=parseFloat(e.max);const n=document.createElement("div");n.className="kpi-card",n.innerHTML=`\n              <div class="kpi-card-info">\n                  <h4>${e.desc}</h4>\n                  <p><small>${e.freq}</small> | Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù‚ØµÙˆÙ‰: <span>${e.max}</span></p>\n              </div>\n              <div class="kpi-card-input">\n                  <input type="number" class="kpi-score-input cont-score" \n                         data-id="${e.id}" data-max="${e.max}"\n                         min="0" max="${e.max}" step="any" placeholder="0">\n              </div>\n          `,gn.appendChild(n)})),fn.textContent=t,hn.textContent="0",vn.style.display="block",document.querySelectorAll(".cont-score").forEach((e=>{e.addEventListener("input",wn)}))}(e.kpis):gn.innerHTML="<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ ØªÙ‚ÙŠÙŠÙ… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</p>"}catch(e){gn.innerHTML=`<p class="error-message">${e.message}</p>`}}else alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ„ ÙˆØ§Ù„Ø´Ù‡Ø±.")}));const bn=document.getElementById("ncr-form"),Bn=document.getElementsByName("report-type"),Ln=document.getElementById("ncr-fields-container"),$n=(document.getElementById("ncr-date"),document.getElementById("ncr-time"),document.getElementById("ncr-issuer"),document.getElementById("ncr-project")),Mn=document.getElementById("ncr-observer-type"),kn=document.getElementById("ncr-emp-group"),Tn=document.getElementById("ncr-cont-group"),xn=(document.getElementById("ncr-observer-emp"),document.getElementById("ncr-show-all-emp"),document.getElementById("ncr-observer-company")),Hn=document.getElementById("ncr-observer-nid"),Sn=document.getElementById("ncr-nid-search-btn"),jn=document.getElementById("ncr-observer-name"),Cn=document.getElementById("ncr-reported-to"),Dn=document.getElementById("ncr-method"),Nn=document.getElementById("ncr-desc"),An=document.getElementById("ncr-root"),Pn=document.getElementById("ncr-act-text"),Un=document.getElementById("ncr-act-resp"),zn=document.getElementById("ncr-act-date"),On=document.getElementById("ncr-add-act-btn"),Rn=document.getElementById("ncr-actions-list"),qn=document.getElementById("ncr-save-btn"),Fn=document.getElementById("ncr-save-msg");let _n=[];function Kn(e,t){if(!e)return;e.querySelectorAll("input, select, textarea, button").forEach((e=>{"report-type"!==e.name&&"vio-level"!==e.name&&(e.disabled=!t)}))}async function Vn(){console.log("Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ ØµÙØ­Ø© NCR ÙˆØ§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø·ÙˆØ±Ø©)..."),document.getElementById("ncr-emp-name-display")&&(document.getElementById("ncr-emp-name-display").value=""),document.getElementById("ncr-emp-id-hidden")&&(document.getElementById("ncr-emp-id-hidden").value=""),document.getElementById("vio-emp-name-display")&&(document.getElementById("vio-emp-name-display").value=""),document.getElementById("vio-emp-id-hidden")&&(document.getElementById("vio-emp-id-hidden").value="");const e=new Date,t=e.toLocaleDateString("en-CA"),n=e.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0});if(document.getElementById("ncr-date")&&(document.getElementById("ncr-date").value=t),document.getElementById("ncr-time")&&(document.getElementById("ncr-time").value=n),document.getElementById("ncr-issuer")&&currentUser&&(document.getElementById("ncr-issuer").value=currentUser.username),!window.ppeEmployees||0===window.ppeEmployees.length)try{const e=await de("getInventoryInitData",{userInfo:currentUser});"success"===e.status&&(window.ppeEmployees=e.employees,console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­."))}catch(e){console.error("Error loading employees for NCR:",e)}if($n&&$n.options.length<=1)if(void 0!==Le&&Le.length>0)ie($n,Le);else try{const e=await de("getInventoryInitData",{userInfo:currentUser});"success"===e.status&&(Le=e.locations,ie($n,e.locations),document.getElementById("vio-project")&&ie(document.getElementById("vio-project"),e.locations))}catch(e){console.error("Error loading projects:",e)}_n=[],Qn(),Yn()}function Yn(){"NCR"===document.querySelector('input[name="report-type"]:checked').value?(Ln.style.display="block",no.style.display="none",Kn(Ln,!0),Kn(no,!1),Wn()):(Ln.style.display="none",no.style.display="block",Kn(Ln,!1),Kn(no,!0),ko())}function Wn(){"Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠ"===Mn.value?(kn.style.display="block",Tn.style.display="none",Kn(kn,!0),Kn(Tn,!1)):(kn.style.display="none",Tn.style.display="block",Kn(kn,!1),Kn(Tn,!0),async function(){const e=$n.value;if(!e)return;xn.innerHTML="<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>";try{const t=await de("getContractorsForProject",{projectName:e});ie(xn,t.contractors)}catch(e){}}())}let Jn="";function Gn(e,t){document.getElementById("ncrvio-emp-modal").style.display="flex",document.getElementById("ncrvio-emp-search-box").value="",document.getElementById("ncrvio-emp-search-box").focus();Xn(t?window.ppeEmployees:window.ppeEmployees.filter((t=>t.project===e)))}function Xn(e){document.getElementById("ncrvio-emp-list-container").innerHTML=0===e.length?'<p style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>':e.map((e=>`\n              <div class="ppe-cart-item" style="cursor:pointer; margin-bottom:8px;" \n                   onclick="window.selectNcrVioEmployee('${e.id}', '${e.name}')">\n                  <div style="text-align:right;">\n                      <span style="display:block; font-weight:700;">${e.name}</span>\n                      <small style="color:#666;">ID: ${e.id} | Project: ${e.project}</small>\n                  </div>\n              </div>`)).join("")}function Qn(){Rn&&(Rn.innerHTML=_n.length?_n.map(((e,t)=>`<div class="ppe-cart-item">\n                  <span>${e.text} <small>(${e.resp} - ${e.date})</small></span>\n                  <button type="button" class="btn-small btn-danger" onclick="remNcrAct(${t})">X</button>\n              </div>`)).join(""):'<p style="text-align:center; color:#777;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</p>')}window.openNcrEmpSelector=function(){const e=document.getElementById("ncr-project").value,t=document.getElementById("ncr-show-all-emp").checked;e||t?(Jn="NCR",document.getElementById("ncrvio-modal-title").innerText="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙØ¨Ù„Øº (NCR)",Gn(e,t)):alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹")},window.openVioEmpSelector=function(){const e=document.getElementById("vio-project").value,t=document.getElementById("vio-show-all-emp").checked;e||t?(Jn="VIO",document.getElementById("ncrvio-modal-title").innerText="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø®Ø§Ù„Ù",Gn(e,t)):alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹")},window.closeNcrVioEmpSelector=function(){document.getElementById("ncrvio-emp-modal").style.display="none"},window.filterNcrVioEmpList=function(){const e=document.getElementById("ncrvio-emp-search-box").value.toLowerCase(),t="NCR"===Jn?document.getElementById("ncr-project").value:document.getElementById("vio-project").value;Xn((("NCR"===Jn?document.getElementById("ncr-show-all-emp").checked:document.getElementById("vio-show-all-emp").checked)?window.ppeEmployees:window.ppeEmployees.filter((e=>e.project===t))).filter((t=>t.name.toLowerCase().includes(e)||t.id.toString().includes(e))))},window.selectNcrVioEmployee=function(e,t){"NCR"===Jn?(document.getElementById("ncr-emp-name-display").value=t,document.getElementById("ncr-emp-id-hidden").value=e):(document.getElementById("vio-emp-name-display").value=t,document.getElementById("vio-emp-id-hidden").value=e),window.closeNcrVioEmpSelector()},window.remNcrAct=e=>{_n.splice(e,1),Qn()},bn&&bn.addEventListener("submit",(async e=>{e.preventDefault();const t=document.querySelector('input[name="report-type"]:checked');if("NCR"===(t?t.value:"NCR")){const e={project:$n.value,reportedTo:Cn.value,method:Dn.value,description:Nn.value,rootCauses:An.value,observer:{type:Mn.value},actions:_n};if(!(e.project&&e.reportedTo&&e.method&&e.description&&e.rootCauses))return void showMessage(Fn,"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù€ NCR.",!1);if("Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠ"===e.observer.type){const t=document.getElementById("ncr-emp-id-hidden").value,n=$e.find((e=>e.id==t));if(!n)return void showMessage(Fn,"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù (Ø§Ù„Ù…ÙØ¨Ù„Øº).",!1);e.observer.id=n.id,e.observer.name=n.name,e.observer.company="Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠ"}else if(e.observer.id=Hn.value,e.observer.name=jn.value,e.observer.company=xn.value,e.observer.isNew=!jn.disabled,!e.observer.id||!e.observer.name||!e.observer.company)return void showMessage(Fn,"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ù†Ø§Ù‚ØµØ© (Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø´Ø±ÙƒØ©).",!1);if(0===e.actions.length&&!confirm("Ù„Ù… ØªØ¶Ù Ø£ÙŠ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªØµØ­ÙŠØ­ÙŠØ©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­ÙØ¸ Ø¨Ø¯ÙˆÙ† Ø¥Ø¬Ø±Ø§Ø¡Ø§ØªØŸ"))return;qn.disabled=!0,qn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';try{const t=await de("saveNCR",{ncrData:e,userInfo:currentUser});showMessage(Fn,t.message,!0),bn.reset(),Vn()}catch(e){showMessage(Fn,e.message,!1)}finally{qn.disabled=!1,qn.innerHTML="Ø­ÙØ¸ NCR"}}else{const e=document.querySelector('input[name="vio-level"]:checked'),t=e?e.value:"Level 1",n=lo.value,o={project:co.value,desc:po.value,hseStatement:uo.value,violatorStatement:yo.value,actionTaken:go.value,level:t,totalValue:"Level 3"===t?parseFloat(Lo.textContent):0,items:"Level 3"===t?$o:[],detailsText:"Level 3"===t?$o.map((e=>e.appliedText)).join(", "):"N/A",violator:{type:n}};if(!(o.project&&o.desc&&o.actionTaken&&o.hseStatement))return void showMessage(Fn,"ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù…Ø®Ø§Ù„ÙØ© (Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø§Ù„ÙˆØµÙØŒ Ø§Ù„Ø£Ù‚ÙˆØ§Ù„ØŒ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡).",!1);if("Ù…ÙˆØ¸Ù"===n){const e=document.getElementById("vio-emp-id-hidden").value,t=$e.find((t=>t.id==e));if(!t)return void showMessage(Fn,"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø®Ø§Ù„Ù.",!1);o.violator.id=t.id,o.violator.name=t.name,o.violator.company="Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠ"}else{if(o.violator.company=mo.value,!o.violator.company)return void showMessage(Fn,"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„.",!1);o.violator.name=document.getElementById("vio-cont-worker-name").value||o.violator.company,o.violator.id=document.getElementById("vio-cont-nid").value||"N/A",o.violator.isNew=!1}qn.disabled=!0,qn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';try{const e=await de("saveViolation",{vioData:o,userInfo:currentUser});showMessage(Fn,e.message,!0),bn.reset(),Vn(),$o=[],Ho()}catch(e){showMessage(Fn,e.message,!1)}finally{qn.disabled=!1,qn.innerHTML="Ø­ÙØ¸ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©"}}})),$n&&$n.addEventListener("change",(()=>{document.getElementById("ncr-emp-name-display").value="",document.getElementById("ncr-emp-id-hidden").value=""})),Bn.forEach((e=>e.addEventListener("change",Yn))),Mn&&Mn.addEventListener("change",Wn),Sn&&Sn.addEventListener("click",(async function(){const e=Hn.value;if(e){jn.value="Ø¨Ø­Ø«...",jn.disabled=!0;try{const t=await de("getRecipientByNID",{nationalId:e});"found"===t.status?(jn.value=t.name,xn.value=t.contractor,jn.disabled=!0):(jn.value="",jn.disabled=!1,jn.focus())}catch(e){jn.value="",jn.disabled=!1}}})),On&&On.addEventListener("click",(function(){const e=Pn.value,t=Un.value,n=zn.value;e&&t&&n?(_n.push({text:e,resp:t,date:n}),Qn(),Pn.value="",Un.value="",zn.value=""):alert("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡")}));const Zn=document.getElementById("my-ncr-list"),eo=document.getElementById("refresh-ncr-btn");async function to(){if(Zn){Zn.innerHTML='<div class="loader-small">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';try{const e=await de("getUserOpenNCRs",{userInfo:currentUser});"success"===e.status?function(e){if(!e||0===e.length)return void(Zn.innerHTML='<p style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ù…ÙØªÙˆØ­Ø©.</p>');let t='<table class="results-table">\n          <thead><tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>\n          <tbody>';e.forEach((e=>{let n=e.date;try{const t=new Date(e.date);n=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}catch(e){}t+=`<tr>\n              <td><strong>${e.id}</strong></td>\n              <td style="white-space:nowrap;">${n}</td>\n              <td>${e.project}</td>\n              <td class="desc-cell">${e.desc}</td>\n              <td>\n                  <button class="btn-small btn-danger" onclick="handleCloseNCR('${e.id}')">\n                      Ø¥ØºÙ„Ø§Ù‚\n                  </button>\n              </td>\n          </tr>`})),t+="</tbody></table>",Zn.innerHTML=t}(e.ncrs):Zn.innerHTML=`<p class="error-message">${e.message}</p>`}catch(e){Zn.innerHTML=`<p class="error-message">${e.message}</p>`}}}window.handleCloseNCR=async function(e){const t=prompt("Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Corrective Action Taken):");if(null!==t)if(""!==t.trim()){le("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚...");try{const n=await de("closeNCR",{ncrId:e,closingNote:t});alert(n.message),to()}catch(e){alert("Ø®Ø·Ø£: "+e.message)}finally{re()}}else alert("ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ù…Ù„Ø§Ø­Ø¸Ø©.")},eo&&eo.addEventListener("click",to);const no=document.getElementById("violation-fields-container"),oo=document.getElementById("vio-date"),ao=document.getElementById("vio-time"),so=document.getElementById("vio-issuer"),co=document.getElementById("vio-project"),lo=document.getElementById("vio-type"),ro=document.getElementById("vio-emp-group"),io=document.getElementById("vio-cont-group"),mo=(document.getElementById("vio-emp-select"),document.getElementById("vio-show-all-emp"),document.getElementById("vio-cont-select")),po=(document.getElementById("vio-cont-worker-name"),document.getElementById("vio-cont-nid"),document.getElementById("vio-desc")),uo=document.getElementById("vio-hse-stmt"),yo=document.getElementById("vio-violator-stmt"),go=document.getElementById("vio-action-taken"),vo=document.getElementsByName("vio-level"),ho=document.getElementById("vio-penalty-div"),fo=document.getElementById("vio-item-select"),Eo=document.getElementById("vio-repeat-select"),Io=document.getElementById("vio-qty-group"),wo=document.getElementById("vio-qty-input"),bo=document.getElementById("vio-add-btn"),Bo=document.getElementById("vio-list-container"),Lo=document.getElementById("vio-total-display");document.getElementById("vio-save-btn");let $o=[],Mo=[];function ko(){const e=new Date,t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,n=e.getHours(),o=String(e.getMinutes()).padStart(2,"0"),a=n>=12?"PM":"AM",s=`${String(n%12||12).padStart(2,"0")}:${o} ${a}`;if(oo&&(oo.value=t),ao&&(ao.value=s),so&&currentUser&&(so.value=currentUser.username),co&&co.options.length<=1)if(void 0!==Le&&Le.length>0){const e=(currentUser.projects||"").toString(),t="ALL"===e?Le:Le.filter((t=>e.includes(t)));ie(co,t)}else de("getInventoryInitData",{userInfo:currentUser}).then((e=>{if("success"===e.status){Le=e.locations,$e=e.employees,Me=e.contractors;const t=(currentUser.projects||"").toString(),n="ALL"===t?e.locations:e.locations.filter((e=>t.includes(e)));ie(co,n)}}));To(),$o=[],Ho()}function To(){"Ù…ÙˆØ¸Ù"===lo.value?(ro.style.display="block",io.style.display="none",Kn(ro,!0),Kn(io,!1)):(ro.style.display="none",io.style.display="block",Kn(ro,!1),Kn(io,!0),async function(){const e=co.value;if(!e)return;mo.innerHTML="<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>";try{const t=await de("getContractorsForProject",{projectName:e});ie(mo,t.contractors)}catch(e){}}()),xo()}function xo(){const e=lo.value;if(fo.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© --</option>',Mo.length>0){const t=Mo.filter((t=>t.target===e));t.forEach(((e,t)=>{const n=document.createElement("option");n.text=e.desc,n.value=t,n.dataset.calc=e.calcType,fo.add(n)})),fo.dataset.currentList=JSON.stringify(t)}}function Ho(){Bo.innerHTML="";let e=0,t=[];const n="Ù…ÙˆØ¸Ù"===document.getElementById("vio-type").value?"ÙŠÙˆÙ…":"Ø¬Ù…";$o.forEach(((o,a)=>{e+=o.appliedValue,t.push(o.appliedText);const s=o.appliedValue>0?`${o.appliedValue} ${n}`:"Ø¥Ø¬Ø±Ø§Ø¡ Ø¥Ø¯Ø§Ø±ÙŠ",c=document.createElement("div");c.className="ppe-cart-item",c.innerHTML=`\n              <div style="flex-grow:1;">\n                  <span style="font-weight:bold; display:block;">${o.desc}</span>\n                  <small style="color:#666;">${o.appliedText}</small>\n              </div>\n              <span style="font-weight:bold; color:#C8102E; white-space:nowrap; margin:0 10px;">${s}</span>\n              <button type="button" class="btn-small btn-danger" onclick="remVioItem(${a})">X</button>\n          `,Bo.appendChild(c)})),Lo.textContent=`${e} ${n}`,"undefined"!=typeof vioAdminTextDisplay&&vioAdminTextDisplay&&(vioAdminTextDisplay.value=t.join(" + "))}vo.forEach((e=>{e.addEventListener("change",(()=>{"Level 3"===e.value?(ho.style.display="block",async function(){if(Mo.length>0)return;fo.innerHTML="<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>";try{const e=await de("getPenaltyList",{});"success"===e.status&&(Mo=e.list,xo())}catch(e){console.error(e)}}()):(ho.style.display="none",$o=[],Ho())}))})),fo&&fo.addEventListener("change",(()=>{const e=fo.selectedOptions[0];e&&"Multiply"===e.dataset.calc?Io.style.display="block":(Io.style.display="none",wo.value=1)})),bo&&bo.addEventListener("click",(()=>{const e=fo.value;if(""===e)return;const t=JSON.parse(fo.dataset.currentList)[e],n=Eo.value;let o=parseFloat(wo.value)||1;"Fixed"===t.calcType&&(o=1);let a="",s=0,c="";"First"===n?(a=t.firstTxt,s=Number(t.firstVal)||0,c=t.firstCat):(a=t.repTxt,s=Number(t.repVal)||0,c=t.repCat);const l=s*o;let r=`${t.desc} - ${a}`;o>1&&(r+=` (Ø¹Ø¯Ø¯: ${o})`),$o.push({desc:t.desc,type:n,appliedText:r,appliedValue:l,qty:o}),Ho(),fo.value="",wo.value=1,Io&&(Io.style.display="none")})),window.remVioItem=e=>{$o.splice(e,1),Ho()},co&&co.addEventListener("change",(()=>{document.getElementById("vio-emp-name-display").value="",document.getElementById("vio-emp-id-hidden").value=""})),lo&&lo.addEventListener("change",To),h&&h.addEventListener("click",(async function(){f.innerHTML="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";const e={project:y.value,fromDate:g.value,toDate:v.value};try{!function(e){if(!e||0===e.length)return void(f.innerHTML='<p style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</p>');let t='<table class="results-table">\n          <thead>\n              <tr>\n                  <th>Ø§Ù„Ù†ÙˆØ¹</th>\n                  <th>Ø§Ù„ÙƒÙˆØ¯</th>\n                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>\n                  <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>\n                  <th>Ø§Ù„Ù…ØµØ¯Ø±</th> <th style="width:30%;">Ø§Ù„ÙˆØµÙ</th>\n                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>\n              </tr>\n          </thead>\n          <tbody>';e.forEach((e=>{const n="NCR"===e.type?'<span class="badge bg-warning" style="color:#856404; background:#fff3cd;">NCR</span>':'<span class="badge bg-danger" style="color:#fff; background:#dc3545;">Violation</span>';let o=e.date;try{const t=new Date(e.date);o=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}catch(e){}t+=`<tr>\n              <td>${n}</td>\n              <td style="font-weight:bold;">${e.id}</td>\n              <td style="white-space:nowrap;">${o}</td>\n              <td>${e.project}</td>\n              <td style="color:#0056b3; font-weight:600;">${e.issuer||"-"}</td> <td class="desc-cell">${e.desc}</td>\n              <td><span class="badge ${"Open"===e.status?"bg-danger":"bg-success"}">${e.status}</span></td>\n          </tr>`})),t+="</tbody></table>",f.innerHTML=t}((await de("searchNcrViolations",{filters:e,userInfo:currentUser})).data)}catch(e){f.innerHTML=`<p class="error-message">${e.message}</p>`}}));const So=document.getElementById("contractor-form"),jo=document.getElementById("cont-date"),Co=document.getElementById("cont-time"),Do=document.getElementById("cont-issuer"),No=document.getElementById("cont-project"),Ao=document.getElementById("cont-contractor"),Po=document.getElementById("cont-file"),Uo=document.getElementById("file-name-display"),zo=document.getElementById("cont-save-btn"),Oo=document.getElementById("cont-save-msg");function Ro(){const e=new Date,t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");jo&&(jo.value=`${t}-${n}-${o}`);const a=e.getHours(),s=String(e.getMinutes()).padStart(2,"0"),c=a>=12?"PM":"AM",l=String(a%12||12).padStart(2,"0");if(Co&&(Co.value=`${l}:${s} ${c}`),Do&&(Do.value=currentUser.username),No&&No.options.length<=1)if(void 0!==Le&&Le.length>0){const e=(currentUser.projects||"").toString(),t="ALL"===e?Le:Le.filter((t=>e.includes(t)));ie(No,t)}else de("getInventoryInitData",{userInfo:currentUser}).then((e=>{"success"===e.status&&ie(No,e.locations)}));Ao&&(Ao.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹ --</option>',Ao.disabled=!0)}Po&&Po.addEventListener("change",(function(){this.files&&this.files[0]?(Uo.textContent=this.files[0].name,Uo.style.color="#28a745"):(Uo.textContent="Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù",Uo.style.color="#555")})),So&&So.addEventListener("submit",(async e=>{e.preventDefault();const t=Po.files[0];if(!No.value)return void alert("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹");if(!Ao.value)return void alert("Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„");if(!t)return void alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù.");if(t.size>5242880)return void alert("Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…ÙŠØ¬Ø§).");zo.disabled=!0,zo.innerHTML='<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';const n=new FileReader;n.readAsDataURL(t),n.onload=async function(){try{const e=n.result.split(",")[1],o={project:No.value,contractor:Ao.value,fileName:t.name,mimeType:t.type,fileData:e},a=await de("saveContractorUpload",{data:o,userInfo:currentUser});showMessage(Oo,a.message,!0),So.reset(),Uo.textContent="Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù",Ro()}catch(e){alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹: "+e.message)}finally{zo.disabled=!1,zo.innerHTML='<i class="fas fa-save"></i> Ø­ÙØ¸ ÙˆØ±ÙØ¹ Ø§Ù„Ù…Ù„Ù'}},n.onerror=function(e){alert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: "+e),zo.disabled=!1}})),No&&No.addEventListener("change",(async function(){const e=No.value;if(e){Ao.innerHTML="<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>",Ao.disabled=!0;try{const t=await de("getContractorsForProject",{projectName:e});t.contractors&&t.contractors.length>0?(ie(Ao,t.contractors),Ao.disabled=!1):Ao.innerHTML='<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</option>'}catch(e){Ao.innerHTML="<option>Ø®Ø·Ø£</option>"}}}));const qo=document.getElementById("ana-project"),Fo=document.getElementById("ana-contractor"),_o=document.getElementById("ana-month"),Ko=document.getElementById("ana-cumulative"),Vo=document.getElementById("ana-sort-kpi"),Yo=document.getElementById("ana-merge-proj"),Wo=document.getElementById("ana-search-btn"),Jo=document.getElementById("ana-results-container"),Go=document.getElementById("ana-print-btn");async function Xo(){if(console.log("Analytics Page Init..."),_o&&!_o.value){const e=new Date;_o.value=`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}`}if(qo&&qo.options.length<=1){qo.innerHTML='<option value="ALL_ACCESSIBLE">ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</option>';let e=[];if(initialData&&initialData.projects&&initialData.projects.length>0)e=initialData.projects;else if(void 0!==Le&&Le.length>0)e=Le;else try{const t=await de("getInventoryInitData",{userInfo:currentUser});"success"===t.status&&(e=t.locations,Le=t.locations,initialData={projects:t.locations})}catch(e){console.error("Failed to load projects for analytics:",e)}e.length>0&&e.forEach((e=>qo.add(new Option(e,e))))}}qo&&qo.addEventListener("change",(async function(){const e=qo.value;if(Fo.innerHTML='<option value="ALL">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>',"ALL_ACCESSIBLE"!==e)try{const t=await de("getContractorsForProject",{projectName:e});Fo.innerHTML='<option value="ALL">ÙƒÙ„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</option>',t.contractors&&t.contractors.forEach((e=>Fo.add(new Option(e,e))))}catch(e){Fo.innerHTML='<option value="ALL">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>'}else Fo.innerHTML='<option value="ALL">ÙƒÙ„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</option>'})),Wo&&Wo.addEventListener("click",(async function(){Jo.innerHTML='<div class="loader-small">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...</div>';const e={project:qo.value,contractor:Fo.value,month:_o.value,isCumulative:Ko.checked,sortKpi:Vo.checked,mergeProjects:Yo.checked};try{!function(e){if(!e||0===e.length)return void(Jo.innerHTML='<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.</p>');const t=document.getElementById("ana-sort-kpi").checked;let n="";t?(n='\n        <table class="results-table" id="analytics-table">\n          <thead>\n              <tr>\n                  <th style="background:#333; color:#fff; width:50px;">#</th>\n                  <th>Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</th>\n                  <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>\n                  <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (KPI)</th>\n              </tr>\n          </thead>\n          <tbody>',e.forEach(((e,t)=>{let o=parseFloat(e.kpi_score).toFixed(1),a="bg-secondary",s="ØºÙŠØ± Ù…Ù‚ÙŠÙ…";e.has_eval?(a=e.kpi_score<70?"bg-danger":e.kpi_score<90?"bg-warning":"bg-success",s=`${o}%`):s="0% <small>(ØºÙŠØ± Ù…Ù‚ÙŠÙ…)</small>";let c=`#${t+1}`;0===t&&e.kpi_score>0&&(c="ğŸ¥‡"),1===t&&e.kpi_score>0&&(c="ğŸ¥ˆ"),2===t&&e.kpi_score>0&&(c="ğŸ¥‰"),n+=`\n              <tr>\n                  <td style="text-align:center; font-weight:bold;">${c}</td>\n                  <td style="font-weight:bold;">${e.contractor}</td>\n                  <td>${e.project}</td>\n                  <td style="text-align:center;">\n                      <span class="badge ${a}" style="font-size:1em; padding:6px 10px;">\n                          ${s}\n                      </span>\n                  </td>\n              </tr>`})),n+="</tbody></table>"):(n='\n        <table class="results-table" id="analytics-table" style="font-size:0.85rem;">\n          <thead>\n              <tr>\n                  <th class="col-0">Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</th>\n                  <th class="col-1">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>\n                  <th class="col-2">ØªØµØ§Ø±ÙŠØ­</th>\n                  <th class="col-3">ØªØ¯Ø±ÙŠØ¨</th>\n                  <th class="col-4">Induction</th>\n                  <th class="col-5">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>\n                  <th class="col-6">Hazards</th>\n                  <th class="col-7" style="min-width:180px;">Ù…Ù‡Ù…Ø§Øª (PPE)</th>\n                  <th class="col-8">Ù…Ø®Ø§Ù„ÙØ§Øª</th>\n                  <th class="col-9">NCR</th>\n                  <th class="col-10">KPI %</th>\n                  <th class="col-11 no-print">Ù…Ù„Ù</th>\n              </tr>\n          </thead>\n          <tbody>',e.forEach((e=>{let t=parseFloat(e.kpi_score).toFixed(1),o="bg-secondary",a="0%";e.has_eval&&(o=e.kpi_score<70?"bg-danger":e.kpi_score<90?"bg-warning":"bg-success",a=`${t}%`);let s="0";if(e.ppe_details_text&&"0"!==e.ppe_details_text){s=e.ppe_details_text.split(" | ").map((e=>{const t=e.split(": ");return`<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:2px 0;">\n                                <span>${t[0]}</span>\n                                <span style="font-weight:bold; color:#0056b3;">${t[1]}</span>\n                            </div>`})).join("")}n+=`\n              <tr>\n                  <td class="col-0" style="font-weight:bold;">${e.contractor}</td>\n                  <td class="col-1">${e.project}</td>\n                  <td class="col-2" style="text-align:center;">${e.permits}</td>\n                  <td class="col-3" style="text-align:center;">${e.training_regular}</td>\n                  <td class="col-4" style="text-align:center;">${e.training_induction}</td>\n                  <td class="col-5" style="text-align:center;">${e.observations}</td>\n                  <td class="col-6" style="text-align:center;">${e.hazards}</td>\n\n                  <td class="col-7">${s}</td>\n\n                  <td class="col-8" style="text-align:center; color:${e.violations>0?"red":"inherit"}; font-weight:${e.violations>0?"bold":"normal"};">${e.violations}</td>\n                  <td class="col-9" style="text-align:center; color:${e.ncr>0?"red":"inherit"}; font-weight:${e.ncr>0?"bold":"normal"};">${e.ncr}</td>\n\n                  <td class="col-10" style="text-align:center;">\n                      <span class="badge ${o}">\n                          ${a}\n                      </span>\n                  </td>\n\n                  <td class="col-11 no-print">\n                      ${e.req_url?`<a href="${e.req_url}" target="_blank" class="btn-small btn-secondary"><i class="fas fa-file-pdf"></i></a>`:"-"}\n                  </td>\n              </tr>`})),n+="</tbody></table>");Jo.innerHTML=n}((await de("getContractorAnalytics",{filters:e})).data)}catch(e){Jo.innerHTML=`<p class="error-message">${e.message}</p>`}})),Go&&Go.addEventListener("click",(function(){const e=document.querySelectorAll('.columns-selector input[type="checkbox"]');e.forEach((e=>{const t=`col-${e.dataset.col}`;document.querySelectorAll(`.${t}`).forEach((t=>{e.checked?t.style.display="":t.style.display="none"}))}));const t=document.getElementById("print-date-display");t&&(t.textContent=`ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±: ${_o.value} | ØªÙ… Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙÙŠ: ${(new Date).toLocaleString("ar-EG")}`),window.print(),setTimeout((()=>{e.forEach((e=>{const t=`col-${e.dataset.col}`;document.querySelectorAll(`.${t}`).forEach((e=>e.style.display=""))}))}),1e3)}));const Qo=document.getElementById("emp-search-input"),Zo=document.getElementById("emp-search-results"),ea=document.getElementById("emp-report-container"),ta=document.getElementById("emp-print-btn");let na=[];function oa(e,t,n,o){const a=document.getElementById(e);if(0===n.length)return void(a.innerHTML='<p style="color:#777; text-align:center; padding:10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</p>');let s='<table class="results-table" style="width:100%"><thead><tr>';t.forEach((e=>s+=`<th>${e}</th>`)),s+="</tr></thead><tbody>",n.forEach((e=>{s+="<tr>",o.forEach((t=>s+=`<td>${e[t]||"-"}</td>`)),s+="</tr>"})),s+="</tbody></table>",a.innerHTML=s}Qo&&Qo.addEventListener("input",(function(){const e=this.value.toLowerCase().trim();if(Zo.innerHTML="",e.length<1)return void(Zo.style.display="none");const t=na.filter((t=>t.name&&t.name.toLowerCase().includes(e)||t.id&&String(t.id).includes(e)));t.length>0?(Zo.style.display="block",t.forEach((e=>{const t=document.createElement("div");t.className="search-item",t.innerHTML=`<strong>${e.name}</strong> <small>(${e.project}) - ID: ${e.id}</small>`,t.addEventListener("click",(()=>{Qo.value=e.name,Zo.style.display="none",async function(e){le("Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ¸Ù...");try{const t=await de("getEmployeeFullReport",{empId:e});"success"===t.status?function(e){const t=e.info;document.getElementById("r-emp-name").textContent=t.name,document.getElementById("r-emp-id").textContent=t.id,document.getElementById("r-emp-job").textContent=t.job,document.getElementById("r-emp-dept").textContent=t.dept,document.getElementById("r-emp-type").textContent=t.type,document.getElementById("r-emp-proj").textContent=t.proj,document.getElementById("r-emp-join").textContent=t.join;const n=parseFloat(e.kpi),o=document.getElementById("r-emp-kpi-val"),a=document.getElementById("r-emp-kpi-circle");o.textContent=n+"%",a.style.borderColor=n>=90?"#28a745":n>=70?"#ffc107":"#dc3545";oa("r-training-table",["Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹","Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"],e.training,["date","topic","project"]),oa("r-ppe-table",["Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„ØµÙ†Ù","Ø§Ù„ÙƒÙ…ÙŠØ©","Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"],e.ppe,["date","item","qty","project"]),oa("r-violations-table",["Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„ÙˆØµÙ","Ø§Ù„Ø¬Ø²Ø§Ø¡","Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"],e.violations,["date","desc","penalty","project"]),ea.style.display="block",ta.style.display="block"}(t):alert(t.message)}catch(e){alert("Ø®Ø·Ø£: "+e.message)}finally{re()}}(e.id)})),Zo.appendChild(t)}))):Zo.style.display="none"})),ta&&ta.addEventListener("click",(()=>{const e=new Date;document.getElementById("emp-print-date").textContent="ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: "+e.toLocaleDateString("ar-EG"),window.print()}));const aa=document.getElementById("accident-form"),sa=document.getElementById("acc-reporter"),ca=document.getElementById("acc-date"),la=document.getElementById("acc-time"),ra=document.getElementById("acc-project"),ia=document.getElementById("acc-class"),da=document.getElementById("acc-injuries-count-group"),ma=document.getElementById("acc-injuries-count"),pa=document.getElementById("acc-routine"),ua=document.getElementById("acc-what-happened"),ya=document.getElementById("acc-notification"),ga=document.getElementById("acc-damage-desc"),va=document.getElementById("acc-vic-type"),ha=document.getElementById("acc-vic-emp-select"),fa=document.getElementById("acc-vic-emp-all"),Ea=document.getElementById("acc-vic-cont-select"),Ia=document.getElementById("acc-vic-nid"),wa=document.getElementById("acc-vic-cont-name"),ba=document.getElementById("acc-vic-vis-nid"),Ba=document.getElementById("acc-vic-vis-name"),La=(document.getElementById("acc-involved-list"),document.getElementById("acc-witness-list"),document.getElementById("acc-direct-list"),document.getElementById("acc-indirect-list"),document.getElementById("acc-root-list"),document.getElementById("acc-imm-list"),document.getElementById("acc-short-list"),document.getElementById("acc-long-list"),document.getElementById("acc-plan-body")),$a=document.getElementById("person-modal"),Ma=document.getElementById("modal-type"),ka=document.getElementById("modal-emp-select"),Ta=(document.getElementById("modal-emp-all"),document.getElementById("modal-cont-select")),xa=document.getElementById("modal-nid"),Ha=document.getElementById("modal-cont-name"),Sa=document.getElementById("modal-vis-nid"),ja=document.getElementById("modal-vis-name");let Ca=[],Da=[],Na=[],Aa="";async function Pa(){console.log("Accident Page Init...");const e=new Date;ca&&(ca.value=e.toLocaleDateString("en-CA"));const t=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0");if(la&&(la.value=`${t}:${n}`),sa&&currentUser&&(sa.value=currentUser.username),ra&&ra.options.length<=1)if(void 0!==Le&&Le.length>0){const e=(currentUser.projects||"").toString(),t="ALL"===e?Le:Le.filter((t=>e.includes(t)));ie(ra,t)}else try{const e=await de("getInventoryInitData",{userInfo:currentUser});if("success"===e.status){Le=e.locations,$e=e.employees,Me=e.contractors;const t=(currentUser.projects||"").toString(),n="ALL"===t?e.locations:e.locations.filter((e=>t.includes(e)));ie(ra,n)}}catch(e){console.error(e)}Ca=[],Da=[],Na=[],za("acc-involved-list",[]),za("acc-witness-list",[]),Oa(),document.querySelectorAll(".simple-list").forEach((e=>e.innerHTML="")),toggleInjuryCount()}function Ua(e,t,n){if(e.innerHTML='<option value="">-- Ø§Ø®ØªØ± --</option>',void 0===$e)return;(t?$e:$e.filter((e=>e.project===n))).forEach((n=>{const o=new Option(`${n.name} (${t?n.project:""})`,n.name);o.dataset.id=n.id,o.dataset.company="Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠ",e.add(o)}))}function za(e,t){const n=document.getElementById(e);n.innerHTML="";let o="";"acc-involved-list"===e?o="involved-empty-msg":"acc-witness-list"===e&&(o="witness-empty-msg");const a=document.getElementById(o);0===t.length?a&&(a.style.display="block"):(a&&(a.style.display="none"),t.forEach(((t,o)=>{const a=document.createElement("li");a.innerHTML=`\n                <div>\n                    <span>${t.name}</span>\n                    <br>\n                    <small><i class="fas fa-id-badge"></i> ${t.type}</small> \n                    ${t.company?`<small>| <i class="fas fa-building"></i> ${t.company}</small>`:""}\n                </div>\n                <button type="button" class="btn-small btn-danger" onclick="removeAccPerson('${e}', ${o})">\n                    <i class="fas fa-trash"></i>\n                </button>`,n.appendChild(a)})))}function Oa(){La.innerHTML="",Na.forEach(((e,t)=>{const n=document.createElement("tr");n.innerHTML=`<td>${e.action}</td><td>${e.resp}</td><td>${e.date}</td><td><button type="button" class="btn-small btn-danger" onclick="remAccPlan(${t})">x</button></td>`,La.appendChild(n)}))}window.loadProjectDataForAccident=async function(){const e=ra.value;if(e){Ua(ha,fa.checked,e),Ea.innerHTML="<option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>";try{const t=await de("getContractorsForProject",{projectName:e});t.contractors&&(ie(Ea,t.contractors),ie(Ta,t.contractors))}catch(e){Ea.innerHTML="<option>Ø®Ø·Ø£</option>"}}},window.toggleInjuryCount=function(){const e=ia.value,t=document.getElementById("acc-victim-section"),n=document.getElementById("acc-injuries-count");"Property Damage"===e||"Nearmiss"===e||"Environmental Incident"===e?(da.style.display="none",n.value="0",n.removeAttribute("required"),n.setAttribute("min","0"),t&&(t.style.display="none")):(da.style.display="block","0"!=n.value&&""!=n.value||(n.value="1"),n.setAttribute("required","required"),n.setAttribute("min","1"),t&&(t.style.display="block"))},window.updatePersonInputs=function(e){const t=document.getElementById(`${e}-type`).value;if(document.getElementById(`${e}-emp-group`).style.display="Employee"===t?"block":"none",document.getElementById(`${e}-cont-group`).style.display="Contractor"===t?"block":"none",document.getElementById(`${e}-vis-group`).style.display="Visitor"===t||"Public"===t?"block":"none","Employee"===t){const t=ra.value;Ua(document.getElementById(`${e}-emp-select`),document.getElementById(`${e}-emp-all`).checked,t)}},window.toggleAllEmployees=function(e){const t=ra.value;Ua(document.getElementById(`${e}-emp-select`),document.getElementById(`${e}-emp-all`).checked,t)},window.searchPersonByNID=async function(e){const t=document.getElementById(`${e}-nid`),n=document.getElementById(`${e}-cont-name`),o=document.getElementById(`${e}-cont-select`);if(t.value){n.value="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...",n.readOnly=!0;try{const e=await de("getRecipientByNID",{nationalId:t.value});"found"===e.status?(n.value=e.name,o.value=e.contractor,n.readOnly=!0,alert("ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡.")):(n.value="",n.placeholder="Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯... Ø£Ø¯Ø®Ù„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹",n.readOnly=!1,alert("ØºÙŠØ± Ù…Ø³Ø¬Ù„ØŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…."))}catch(e){n.value="",n.readOnly=!1}}else alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ")},window.openPersonModal=function(e){Aa=e,document.getElementById("person-modal-title").textContent="involved"===e?"Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ Ù…ØªØ¯Ø§Ø®Ù„":"Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ù‡Ø¯",$a.style.display="block",Ma.value="",updatePersonInputs("modal"),xa.value="",Ha.value="",Sa.value="",ja.value=""},window.closePersonModal=function(){$a.style.display="none"},window.confirmAddPerson=function(){const e=Ma.value;if(!e)return;let t={type:e,isNew:!1};if("Employee"===e){const e=ka;t.name=e.value,t.id=e.options[e.selectedIndex]?.dataset.id||"N/A",t.company="Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠ"}else"Contractor"===e?(t.company=Ta.value,t.id=xa.value,t.name=Ha.value,t.isNew=!Ha.readOnly):(t.id=Sa.value,t.name=ja.value,t.company="Visitor/Public",t.isNew=!0);t.name?("involved"===Aa?(Ca.push(t),za("acc-involved-list",Ca)):(Da.push(t),za("acc-witness-list",Da)),closePersonModal()):alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨")},window.removeAccPerson=function(e,t){"acc-involved-list"===e?(Ca.splice(t,1),za(e,Ca)):(Da.splice(t,1),za(e,Da))},window.addToList=function(e,t){const n=document.getElementById(e),o=n.value.trim();if(!o)return;const a=document.getElementById(t),s=document.createElement("li");s.innerHTML=`<span>${o}</span> <button type="button" class="btn-small btn-danger" onclick="this.parentElement.remove()">x</button>`,a.appendChild(s),n.value=""},window.addActionPlanRow=function(){const e=document.getElementById("plan-action").value,t=document.getElementById("plan-resp").value,n=document.getElementById("plan-date").value;e&&t?(Na.push({action:e,resp:t,date:n}),Oa(),document.getElementById("plan-action").value="",document.getElementById("plan-resp").value="",document.getElementById("plan-date").value=""):alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")},window.remAccPlan=function(e){Na.splice(e,1),Oa()},aa&&aa.addEventListener("submit",(async e=>{if(e.preventDefault(),!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŸ"))return;const t=ia.value,n=e=>Array.from(document.querySelectorAll(`#${e} li span`)).map((e=>e.textContent));let o={type:"N/A",name:"N/A",id:"N/A",company:"N/A",isNew:!1};if(!["Property Damage","Environmental Incident","Nearmiss"].includes(t)){const e=va.value;if(o.type=e,"Employee"===e){const e=ha;o.name=e.value,o.id=e.options[e.selectedIndex]?.dataset.id||"",o.company="Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠ"}else"Contractor"===e?(o.company=Ea.value,o.id=Ia.value,o.name=wa.value,o.isNew=!wa.readOnly):"Visitor"===e&&(o.id=ba.value,o.name=Ba.value,o.company="Visitor/Public",o.isNew=!0);if(!o.name||"N/A"===o.name)return void alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø¹Ù†ÙŠ Ø¨Ø§Ù„Ø­Ø§Ø¯Ø« (Ø§Ù„Ù…ØµØ§Ø¨) Ù†Ø§Ù‚ØµØ©")}const a={date:ca.value,time:la.value,project:ra.value,classification:t,injuriesCount:ma.value,routineActivity:pa.value,whatHappened:ua.value,notificationInfo:ya.value,injuriesDesc:ga.value,victim:o,involved:Ca,witnesses:Da,directCauses:n("acc-direct-list"),indirectCauses:n("acc-indirect-list"),rootCauses:n("acc-root-list"),immediateActions:n("acc-imm-list"),shortTermActions:n("acc-short-list"),longTermActions:n("acc-long-list"),actionPlan:Na},s=aa.querySelector('button[type="submit"]');s.disabled=!0,s.textContent="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";try{const e=await de("saveAccident",{accidentData:a,userInfo:currentUser});alert(e.message),aa.reset(),Pa()}catch(e){alert("Ø®Ø·Ø£: "+e.message)}finally{s.disabled=!1,s.textContent="Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"}})),window.loadUserOpenAccidents=async function(){const e=document.getElementById("open-accidents-list");if(e){e.innerHTML='<div class="loader-small">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';try{const t=await de("getUserOpenAccidents",{userInfo:currentUser});if("success"===t.status&&t.accidents.length>0){let n="";t.accidents.forEach((e=>{n+=`\n                  <div class="permit-card" style="border-left: 5px solid #ff9800;">\n                      <div class="permit-info">\n                          <p><strong>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:</strong> ${e.project}</p>\n                          <p><strong>Ø§Ù„ØªØµÙ†ÙŠÙ:</strong> ${e.class}</p>\n                          <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${e.date?new Date(e.date).toLocaleDateString("en-GB"):"-"}</p>\n                          <p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${e.desc.substring(0,60)}...</p>\n                      </div>\n                      <button class="btn-danger" onclick="closeAccidentPrompt('${e.id}')">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø§Ø¯Ø«</button>\n                  </div>`})),e.innerHTML=n}else e.innerHTML="<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ÙˆØ§Ø¯Ø« Ù…ÙØªÙˆØ­Ø©.</p>"}catch(t){e.innerHTML=`<p class="error-message">${t.message}</p>`}}},window.closeAccidentPrompt=async function(e){const t=prompt("Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„):");if(t){le("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚...");try{const n=await de("closeAccident",{accId:e,closingNote:t});alert(n.message),loadUserOpenAccidents()}catch(e){alert(e.message)}finally{re()}}};const Ra=document.getElementById("mon-acc-project"),qa=document.getElementById("mon-acc-from"),Fa=document.getElementById("mon-acc-to"),_a=document.getElementById("mon-acc-open"),Ka=document.getElementById("mon-acc-btn"),Va=document.getElementById("mon-acc-results"),Ya=document.getElementById("mon-acc-print-btn"),Wa=document.getElementById("acc-print-date");window.toggleAllAccidents=function(e){document.querySelectorAll(".acc-print-check").forEach((t=>t.checked=e.checked))},Ka&&Ka.addEventListener("click",(async function(){Va.innerHTML='<div class="loader-small">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>',Ya.style.display="none";const e={project:Ra.value,fromDate:qa.value,toDate:Fa.value,openOnly:_a.checked};try{!function(e){if(!e||0===e.length)return void(Va.innerHTML='<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ÙˆØ§Ø¯Ø« Ù…Ø·Ø§Ø¨Ù‚Ø©.</p>');let t='\n      <table class="results-table" id="acc-print-table">\n        <thead>\n            <tr>\n                <th class="print-select-col" style="width:40px; text-align:center;">\n                    <input type="checkbox" onchange="toggleAllAccidents(this)">\n                </th>\n                <th>Ø§Ù„ÙƒÙˆØ¯</th>\n                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>\n                <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>\n                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>\n                <th>Ø§Ù„ÙˆØµÙ</th>\n                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>\n            </tr>\n        </thead>\n        <tbody>';e.forEach((e=>{t+=`\n          <tr class="acc-row">\n              <td class="print-select-col" style="text-align:center;">\n                  <input type="checkbox" class="acc-print-check" checked> \n              </td>\n              <td style="font-weight:bold;">${e.id}</td>\n              <td style="white-space:nowrap;">${e.date}</td>\n              <td>${e.project}</td>\n              <td style="color:#C8102E; font-weight:600;">${e.classification}</td>\n              <td class="desc-cell">${e.description}</td>\n              <td>\n                  <span class="badge ${"Open"===e.status?"bg-danger":"bg-success"}">\n                    ${e.status}\n                  </span>\n              </td>\n          </tr>`})),t+="</tbody></table>",Va.innerHTML=t,Ya.style.display="block"}((await de("searchAccidents",{filters:e,userInfo:currentUser})).data)}catch(e){Va.innerHTML=`<p class="error-message">${e.message}</p>`}})),Ya&&Ya.addEventListener("click",(function(){const e=document.querySelectorAll(".acc-row");let t=!1;e.forEach((e=>{const n=e.querySelector(".acc-print-check");n&&!n.checked?e.classList.add("hide-on-print"):(e.classList.remove("hide-on-print"),t=!0)})),t?(Wa&&(Wa.textContent=`ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${(new Date).toLocaleDateString("ar-EG")}`),window.print(),setTimeout((()=>{e.forEach((e=>e.classList.remove("hide-on-print")))}),1e3)):alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ø¯Ø« ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.")})),window.initTrainingLogPage=function(){const e=document.getElementById("train-project-filter");e&&initialData&&initialData.projects&&ie(e,initialData.projects),document.getElementById("training-table-body").innerHTML='<tr><td colspan="6" style="text-align:center; padding:20px;">Ø­Ø¯Ø¯ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø¨Ø­Ø«...</td></tr>'},window.fetchTrainingLogs=async function(){const e=document.getElementById("train-start-date").value,t=document.getElementById("train-end-date").value,n=document.getElementById("train-project-filter").value;le("Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨...");try{const o=await de("getTrainingLogs",{startDate:e,endDate:t,filterProject:n||"all",userInfo:currentUser});"success"===o.status?(Ga=o.data.reverse(),function(e){const t=document.getElementById("training-table-body");t.innerHTML=0===e.length?"<tr><td colspan='6' style='text-align:center;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>":"",e.forEach(((e,n)=>{t.insertAdjacentHTML("beforeend",`\n        <tr>\n          <td>${e.date}</td>\n          <td>${e.project}</td>\n          <td style="font-weight:bold; color:var(--primary-color)">${e.topic}</td>\n          <td>${e.trainer}</td>\n          <td style="text-align:center;"><span class="badge bg-danger">${e.attendees.length}</span></td>\n          <td style="text-align:center;"><button class="btn-small btn-secondary" onclick="window.openAttendeesModal(${n})"><i class="fas fa-eye"></i></button></td>\n        </tr>`)}))}(o.data)):alert("Ø®Ø·Ø£: "+o.message)}catch(e){alert(e.message)}finally{re()}};let Ja=[],Ga=[],Xa=[];function Qa(e){const t=document.getElementById("worker-list-container");e&&0!==e.length?t.innerHTML=e.map((e=>`\n          <div class="ppe-cart-item" style="cursor:pointer; margin-bottom:5px;" onclick="window.selectWorker('${e.id}', '${e.name}')">\n              <div style="text-align:right;">\n                  <span style="display:block; font-weight:700;">${e.name}</span>\n                  <small style="color:#666;">ID: ${e.id}</small>\n              </div>\n              <i class="fas fa-chevron-left" style="color:#ccc;"></i>\n          </div>\n      `)).join(""):t.innerHTML='<p style="text-align:center; padding:20px; color:#999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ø§Ù„ Ù…Ø³Ø¬Ù„ÙŠÙ† Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ©</p>'}window.loadContractorWorkers=async function(){const e=document.getElementById("trn-cont-company").value,t=document.getElementById("trn-workers-list"),n=document.getElementById("trn-cont-name"),o=document.getElementById("trn-cont-nid");if(e)try{const a=await de("getContractorWorkers",{contractorName:e});"success"===a.status&&(Ja=a.workers,t.innerHTML=a.workers.map((e=>`<option value="${e.name}">${e.id}</option>`)).join(""),console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${a.workers.length} Ø¹Ø§Ù…Ù„ Ù„Ø´Ø±ÙƒØ© ${e}`),n.value="",o.value="")}catch(e){console.error(e)}else t.innerHTML=""},window.handleTrnNameInput=function(){const e=document.getElementById("trn-cont-name"),t=document.getElementById("trn-cont-nid"),n=e.value,o=Ja.find((e=>e.name===n));o?(t.value=o.id,t.readOnly=!0,t.style.backgroundColor="#f0f0f0"):(t.readOnly=!1,t.style.backgroundColor="#fff")},window.openAttendeesModal=function(e){const t=Ga[e];t&&(document.getElementById("modal-session-title").innerText=`Ø­Ø¶ÙˆØ±: ${t.topic}`,document.getElementById("attendees-list-body").innerHTML=t.attendees.map(((e,t)=>`\n        <tr>\n            <td>${t+1}</td>\n            <td style="font-weight:600">${e.name}</td>\n            <td>${e.company}</td>\n            <td><span class="badge">${e.type}</span></td>\n        </tr>`)).join(""),document.getElementById("attendees-modal").style.display="flex")},window.closeAttendeesModal=function(){document.getElementById("attendees-modal").style.display="none"},window.addEventListener("click",(e=>{const t=document.getElementById("attendees-modal");e.target===t&&window.closeAttendeesModal()})),window.openWorkerSelector=function(){document.getElementById("trn-cont-company").value?(document.getElementById("worker-selector-modal").style.display="flex",document.getElementById("worker-search-box").value="",document.getElementById("worker-search-box").focus(),Qa(Ja)):alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹")},window.closeWorkerSelector=function(){document.getElementById("worker-selector-modal").style.display="none"},window.filterWorkerList=function(){const e=document.getElementById("worker-search-box").value.toLowerCase();Qa(Ja.filter((t=>t.name.toLowerCase().includes(e)||t.id.includes(e))))},window.selectWorker=function(e,t){document.getElementById("trn-cont-name").value=t,document.getElementById("trn-cont-nid").value=e,document.getElementById("trn-cont-nid").readOnly=!0,document.getElementById("trn-cont-nid").style.backgroundColor="#f0f0f0",window.closeWorkerSelector()},window.addNewWorkerManually=function(){const e=document.getElementById("worker-search-box").value;document.getElementById("trn-cont-name").value=e,document.getElementById("trn-cont-nid").value="",document.getElementById("trn-cont-nid").readOnly=!1,document.getElementById("trn-cont-nid").style.backgroundColor="#fff",document.getElementById("trn-cont-nid").focus(),window.closeWorkerSelector()}})),window.openEmpSelector=function(){const e=document.getElementById("trn-project").value,t=document.getElementById("trn-show-all-emp").checked;if(!window.ppeEmployees||0===window.ppeEmployees.length)return void alert("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø«Ø§Ù†ÙŠØ©...");if(!e&&!t)return void alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ„Ø§Ù‹ Ø£Ùˆ ØªÙØ¹ÙŠÙ„ Ø®ÙŠØ§Ø± 'Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†'");document.getElementById("emp-selector-modal").style.display="flex",document.getElementById("emp-search-box").value="";renderEmployeesInModal(t?window.ppeEmployees:window.ppeEmployees.filter((t=>t.project===e)))},window.closeEmpSelector=function(){document.getElementById("emp-selector-modal").style.display="none"},window.filterEmpList=function(){const e=document.getElementById("emp-search-box").value.toLowerCase(),t=document.getElementById("trn-project").value;renderEmployeesInModal((document.getElementById("trn-show-all-emp").checked?ppeEmployees:ppeEmployees.filter((e=>e.project===t))).filter((t=>t.name.toLowerCase().includes(e)||t.id.toString().includes(e))))},window.selectEmployee=function(e,t,n){document.getElementById("trn-emp-name-display").value=t,document.getElementById("trn-emp-id-hidden").value=e,window.closeEmpSelector(),kpiPeriodSelect&&kpiPeriodSelect.addEventListener("change",(()=>{kpiListContainer.innerHTML="<p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©...</p>",document.getElementById("kpi-emp-name-display").value="",document.getElementById("kpi-emp-id-hidden").value=""}))},window.buildKpiForm=function(e){const t=document.getElementById("kpi-list-container");t&&(t.innerHTML="",e.forEach(((e,n)=>{const o=document.createElement("div");o.className="kpi-card",o.dataset.kpiId=e.kpiId,o.dataset.maxScore=e.maxScore,o.innerHTML=`\n            <div class="kpi-card-info">\n                <h4>${n+1}. ${e.description||"N/A"}</h4>\n                <p>Ø§Ù„ØªÙƒØ±Ø§Ø±: <span>${e.frequency||"-"}</span> | Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù‚ØµÙˆÙ‰: <span>${e.maxScore||0}</span></p>\n            </div>\n            <div class="kpi-card-input">\n                <div class="score-group">\n                    <label>Ø§Ù„Ø¯Ø±Ø¬Ø©:</label>\n                    <input type="number" class="kpi-score-input" \n                           value="${e.scoreAchieved||""}" \n                           min="0" max="${e.maxScore||0}" step="0.5" placeholder="0">\n                </div>\n                <input type="text" class="kpi-notes-input" \n                       value="${e.notes||""}" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)...">\n            </div>`,t.appendChild(o)})))},window.loadKpisForEmployee=async function(e,t){const n=document.getElementById("kpi-list-container"),o=document.getElementById("kpi-guidelines-container"),a=document.getElementById("kpi-save-btn"),s=document.getElementById("kpi-message-area");o&&(o.style.display="none"),n&&(n.innerHTML="<div class='loader-small'>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…...</div>"),a&&(a.style.display="none"),s&&(s.style.display="none");try{const o=await callApi("getKPIsForEmployee",{employeeId:e,period:t,userInfo:currentUser});"success"===o.status&&o.kpis&&(o.kpis.length>0?(window.buildKpiForm(o.kpis),a&&(a.style.display="block")):n.innerHTML="<p class='error-message' style='display:block'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ ØªÙ‚ÙŠÙŠÙ… Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ©.</p>")}catch(e){n.innerHTML="<p class='error-message' style='display:block'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>"}},window.openKpiEmpSelector=async function(){const e=document.getElementById("kpi-period-select"),t=e?e.value:"";if(t){showLoader("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†...");try{const e=await callApi("getKpiInitData",{userInfo:currentUser,selectedPeriod:t});"success"===e.status&&(window.ppeEmployees=e.employees,evaluatedEmpIds=e.evaluatedIds,document.getElementById("kpi-emp-modal").style.display="flex",document.getElementById("kpi-emp-search-box").value="",renderKpiEmpsInModal(window.ppeEmployees))}catch(e){alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: "+e.message)}finally{hideLoader()}}else alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙØªØ±Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹")},window.filterKpiEmpList=function(){const e=document.getElementById("kpi-emp-search-box").value.toLowerCase();renderKpiEmpsInModal(window.ppeEmployees.filter((t=>t.name.toLowerCase().includes(e)||t.id.toString().includes(e))).sort(((e,t)=>(e.project||"").localeCompare(t.project||""))))},window.selectKpiEmployee=function(e,t,n,o){const a=document.getElementById("kpi-emp-name-display"),s=document.getElementById("kpi-emp-id-hidden"),c=document.getElementById("kpi-employee-jobtitle");a&&(a.value=t),s&&(s.value=e),c&&(c.innerHTML=`\n            <span><i class="fas fa-briefcase"></i> ${n||"Ù…ÙˆØ¸Ù"}</span> | \n            <span><i class="fas fa-map-marker-alt"></i> Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ${o||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</span>\n        `,c.style.display="block");const l=document.getElementById("kpi-period-select");if(l&&l.value&&e){const t=`${l.value}-01`;window.loadKpisForEmployee(e,t)}else alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙØªØ±Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹");window.closeKpiEmpSelector()},window.closeKpiEmpSelector=function(){document.getElementById("kpi-emp-modal").style.display="none"},window.handleKpiSave=async function(e){e&&(e.preventDefault(),e.stopPropagation());const t=document.getElementById("kpi-save-btn"),n=document.getElementById("kpi-list-container"),o=document.getElementById("kpi-emp-id-hidden"),a=document.getElementById("kpi-period-select");document.getElementById("kpi-message-area");if(!currentUser||!currentUser.username)return void alert("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");const s=o?o.value:"",c=a?`${a.value}-01`:"";if(!s||!c)return void alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù ÙˆÙØªØ±Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹.");const l=[],r=n.querySelectorAll(".kpi-card");let i=!1;if(r.forEach((e=>{const t=e.dataset.kpiId,n=parseFloat(e.dataset.maxScore),o=e.querySelector(".kpi-score-input"),a=o.value,s=parseFloat(a);""!==a&&(s<0||s>n)?(o.style.borderColor="red",i=!0):o.style.borderColor="",l.push({kpiId:t,score:""===a?null:s,maxScore:n,notes:e.querySelector(".kpi-notes-input")?.value||""})})),i)alert("Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡.");else if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŸ")){t&&(t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');try{const e=await callApi("saveEvaluations",{evaluationsData:{employeeId:s,period:c,scores:l},userInfo:currentUser});window.onSaveEvaluationSuccess(e)}catch(e){alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: "+e.message)}finally{t&&(t.disabled=!1,t.innerHTML='<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª')}}},window.onSaveEvaluationSuccess=async function(e){const t=document.getElementById("kpi-save-message"),n=document.getElementById("kpi-list-container"),o=document.getElementById("kpi-employee-jobtitle"),a=document.getElementById("kpi-guidelines-container");showMessage(t,e.message||"ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!",!0),n&&(n.innerHTML="<p class='success-message'>âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù Ø¢Ø®Ø± Ø§Ù„Ø¢Ù†.</p>"),document.getElementById("kpi-emp-name-display").value="",document.getElementById("kpi-emp-id-hidden").value="",o&&(o.style.display="none"),a&&(a.style.display="block"),await window.initKpiPage()};
// Ù…Ù†Ø¹ ÙƒÙ„ÙŠÙƒ ÙŠÙ…ÙŠÙ†
document.addEventListener("contextmenu", (event) => event.preventDefault());

// Ù…Ù†Ø¹ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ (F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U)
document.onkeydown = function (e) {
  if (e.keyCode == 123) {
    // F12
    return false;
  }
  if (
    e.ctrlKey &&
    e.shiftKey &&
    (e.keyCode == "I".charCodeAt(0) || e.keyCode == "J".charCodeAt(0))
  ) {
    return false;
  }
  if (e.ctrlKey && e.keyCode == "U".charCodeAt(0)) {
    // View Source
    return false;
  }
};

(function () {
  // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ø¬ÙˆØ¬Ù„
  function redirect() {
    window.location.href = "https://www.google.com";
  }

  // 1. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© (Ù„Ùˆ Ø§ØªÙØªØ­Øª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø¨Ø´ÙƒÙ„ Ø¬Ø§Ù†Ø¨ÙŠ Ø£Ùˆ Ø³ÙÙ„ÙŠ)
  const threshold = 160;
  setInterval(() => {
    const widthDiff = window.outerWidth - window.innerWidth > threshold;
    const heightDiff = window.outerHeight - window.innerHeight > threshold;

    if (widthDiff || heightDiff) {
      redirect();
    }
  }, 500);

  // 2. Ø®Ø¯Ø¹Ø© Ø§Ù„Ù€ Debugger (Ù„Ùˆ Ø­Ø§ÙˆÙ„ ÙŠÙØªØ­ Ø§Ù„Ù€ Console)
  setInterval(function () {
    var startTime = performance.now();
    debugger;
    var endTime = performance.now();

    // Ù„Ùˆ Ø§Ù„Ù€ debugger Ø£Ø®Ø¯ ÙˆÙ‚Øª Ø£ÙƒØªØ± Ù…Ù† 100 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©ØŒ Ø¯Ù‡ Ù…Ø¹Ù†Ø§Ù‡ Ø¥Ù† Ø§Ù„Ù€ Inspect Ù…ÙØªÙˆØ­
    if (endTime - startTime > 100) {
      redirect();
    }
  }, 100);

  // 3. Ù…Ù†Ø¹ Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ©
  window.addEventListener("keydown", (e) => {
    if (
      e.keyCode === 123 || // F12
      (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || // Ctrl+Shift+I/J
      (e.ctrlKey && e.keyCode === 85) // Ctrl+U
    ) {
      e.preventDefault();
      redirect();
    }
  });
})();
